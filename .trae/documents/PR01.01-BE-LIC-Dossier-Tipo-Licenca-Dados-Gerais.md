# PR01.01-BE-LIC - Dossier Tipo de Licen√ßa - Dados Gerais

## 1. Vis√£o Geral

Este documento especifica a gest√£o dos dados gerais dos tipos de licen√ßa, incluindo informa√ß√µes b√°sicas, configura√ß√µes de validade, processamento e metadados espec√≠ficos. Este m√≥dulo √© fundamental para definir as caracter√≠sticas operacionais de cada tipo de licenciamento.

**M√≥dulo:** Dossier de Tipo de Licen√ßa - Dados Gerais  
**Endpoint Base:** `/api/v1/license-types`  
**Vers√£o:** 1.0  
**Data:** 2025

<<<<<<< HEAD
<<<<<<< HEAD
---

## 2. Estrutura de Dados Gerais

### 2.1 Informa√ß√µes B√°sicas

#### 2.1.1 Campos Obrigat√≥rios
| Campo | Tipo | Valida√ß√£o | Descri√ß√£o |
|-------|------|-----------|----------|
| name | String | 2-200 chars, NotBlank | Nome do tipo de licen√ßa |
| code | String | Pattern: ^[A-Z0-9_]+$, Unique | C√≥digo identificador √∫nico |
| categoryId | String | NotBlank, Must exist | Refer√™ncia para categoria |
| licensingModelKey | String | NotBlank, Must exist in OPTIONS | Modelo de licenciamento |
| validityPeriod | Integer | Min: 1 | Per√≠odo de validade |
| validityUnitKey | String | NotBlank, Must exist in OPTIONS | Unidade de tempo |
| renewable | Boolean | NotNull | Se a licen√ßa √© renov√°vel |
| autoRenewal | Boolean | NotNull | Se renova automaticamente |
| requiresInspection | Boolean | NotNull | Se requer inspe√ß√£o |
| requiresPublicConsultation | Boolean | NotNull | Se requer consulta p√∫blica |
| hasFees | Boolean | NotNull | Se possui taxas associadas |

#### 2.1.2 Campos Opcionais
| Campo | Tipo | Valida√ß√£o | Descri√ß√£o |
|-------|------|-----------|----------|
| description | String | Max: 1000 chars | Descri√ß√£o detalhada |
| maxProcessingDays | Integer | Min: 1 | Prazo m√°ximo de processamento |
| baseFee | BigDecimal | Min: 0.0 | Taxa base (obrigat√≥rio se hasFees=true) |
| currencyCode | String | Must exist in OPTIONS | C√≥digo da moeda |
| sortOrder | Integer | Min: 0 | Ordem de exibi√ß√£o |
| metadata | Object | JSON v√°lido | Metadados espec√≠ficos |

### 2.2 Estrutura Completa do DTO
=======
- Implementar modelo de dados normalizado `T_LICENSE_PARAMETER`

- Implementar arquitetura DDD para gest√£o de par√¢metros de licen√ßas

- Fornecer APIs REST para configura√ß√£o e consulta de par√¢metros

- Garantir valida√ß√µes robustas de regras de neg√≥cio

=======
- Implementar modelo de dados normalizado `T_LICENSE_PARAMETER`

- Implementar arquitetura DDD para gest√£o de par√¢metros de licen√ßas

- Fornecer APIs REST para configura√ß√£o e consulta de par√¢metros

- Garantir valida√ß√µes robustas de regras de neg√≥cio

>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)
- Suportar diferentes modelos de licenciamento

## 2. Modelo de Dados Normalizado

### 2.1 Diagrama ER

```mermaid
erDiagram
    T_LICENSE_TYPE ||--o{ T_LICENSE_PARAMETER : configures
    T_LICENSE_PARAMETER {
        uuid id PK
        uuid license_type_id_fk FK
        varchar validity_unit
        integer validity_period
        varchar model
        integer provisional_validity
        integer definitive_license_validity
        integer provisional_default_period
        integer definitive_default_period
        integer provisional_renewal_period
        integer max_provisional_renewal
        integer definitive_renewal_period
        integer definitive_renewal_default_period
        integer renewal_default_period
        integer max_renewal_period
        varchar status
        boolean vitality_flag
        timestamp registration_date
        timestamp closing_date
        uuid network_application_id_fk FK
        uuid organization_id_fk FK
        uuid user_id_fk FK
        timestamp created_at
        timestamp updated_at
        varchar created_by
        varchar updated_by
    }

    T_LICENSE_TYPE {
        uuid id PK
        varchar name
        varchar description
        uuid sector_id_fk FK
        boolean simplified_regime
        varchar regime
        boolean active
        timestamp created_at
        timestamp updated_at
    }
```

### 2.2 Defini√ß√£o da Tabela T_LICENSE_PARAMETER

```sql
CREATE TABLE t_license_parameter (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    license_type_id_fk UUID NOT NULL,
    validity_unit VARCHAR(20) NOT NULL,
    validity_period INTEGER NOT NULL CHECK (validity_period > 0),
    model VARCHAR(50) NOT NULL,
    provisional_validity INTEGER CHECK (provisional_validity > 0),
    definitive_license_validity INTEGER CHECK (definitive_license_validity > 0),
    provisional_default_period INTEGER CHECK (provisional_default_period > 0),
    definitive_default_period INTEGER CHECK (definitive_default_period > 0),
    provisional_renewal_period INTEGER CHECK (provisional_renewal_period > 0),
    max_provisional_renewal INTEGER CHECK (max_provisional_renewal >= 0),
    definitive_renewal_period INTEGER CHECK (definitive_renewal_period > 0),
    definitive_renewal_default_period INTEGER CHECK (definitive_renewal_default_period > 0),
    renewal_default_period INTEGER CHECK (renewal_default_period > 0),
    max_renewal_period INTEGER CHECK (max_renewal_period > 0),
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    vitality_flag BOOLEAN NOT NULL DEFAULT true,
    registration_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    closing_date TIMESTAMP WITH TIME ZONE,
    network_application_id_fk UUID,
    organization_id_fk UUID,
    user_id_fk UUID,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100) NOT NULL,
    updated_by VARCHAR(100) NOT NULL,

    CONSTRAINT fk_license_parameter_license_type
        FOREIGN KEY (license_type_id_fk) REFERENCES t_license_type(id),
    CONSTRAINT chk_closing_date_after_registration
        CHECK (closing_date IS NULL OR closing_date > registration_date),
    CONSTRAINT chk_provisional_model_validity
        CHECK (
            (model = 'PROVISIONAL_DEFINITIVE' AND provisional_validity IS NOT NULL) OR
            (model != 'PROVISIONAL_DEFINITIVE' AND provisional_validity IS NULL)
        )
);
```

### 2.3 √çndices

```sql
-- √çndice principal para consultas por tipo de licen√ßa
CREATE INDEX idx_license_parameter_license_type ON t_license_parameter(license_type_id_fk);

-- √çndice para consultas por status
CREATE INDEX idx_license_parameter_status ON t_license_parameter(status) WHERE status = 'ACTIVE';

-- √çndice para auditoria
CREATE INDEX idx_license_parameter_created_at ON t_license_parameter(created_at DESC);

-- √çndice composto para consultas filtradas
CREATE INDEX idx_license_parameter_type_status ON t_license_parameter(license_type_id_fk, status);
```

## 3. Arquitetura DDD

### 3.1 Domain Layer

#### 3.1.1 Aggregate Root: LicenseParameter
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@IgrpDTO
public class LicenseTypeRequestDTO {
    // Informa√ß√µes B√°sicas
    @NotNull(message = "Nome √© obrigat√≥rio")
    @NotBlank(message = "Nome n√£o pode estar vazio")
    @Size(min = 2, max = 200, message = "Nome deve ter entre 2 e 200 caracteres")
    private String name;
    
    @Size(max = 1000, message = "Descri√ß√£o n√£o pode exceder 1000 caracteres")
    private String description;
    
    @NotNull(message = "C√≥digo √© obrigat√≥rio")
    @NotBlank(message = "C√≥digo n√£o pode estar vazio")
    @Pattern(regexp = "^[A-Z0-9_]+$", message = "C√≥digo deve conter apenas letras mai√∫sculas, n√∫meros e underscore")
    private String code;
    
    // Relacionamentos
    @NotNull(message = "Categoria √© obrigat√≥ria")
    @NotBlank(message = "ID da categoria n√£o pode estar vazio")
    private String categoryId;
    
    // Configura√ß√µes de Licenciamento
    @NotNull(message = "Modelo de licenciamento √© obrigat√≥rio")
    @NotBlank(message = "Chave do modelo de licenciamento n√£o pode estar vazia")
    private String licensingModelKey;
    
    // Configura√ß√µes de Validade
    @NotNull(message = "Per√≠odo de validade √© obrigat√≥rio")
    @Min(value = 1, message = "Per√≠odo de validade deve ser pelo menos 1")
    private Integer validityPeriod;
    
    @NotNull(message = "Unidade de validade √© obrigat√≥ria")
    @NotBlank(message = "Chave da unidade de validade n√£o pode estar vazia")
    private String validityUnitKey;
    
    // Configura√ß√µes de Renova√ß√£o
    @NotNull(message = "Campo 'renov√°vel' √© obrigat√≥rio")
    private Boolean renewable;
    
    @NotNull(message = "Campo 'renova√ß√£o autom√°tica' √© obrigat√≥rio")
    private Boolean autoRenewal;
    
    // Configura√ß√µes de Processo
    @NotNull(message = "Campo 'requer inspe√ß√£o' √© obrigat√≥rio")
    private Boolean requiresInspection;
    
    @NotNull(message = "Campo 'requer consulta p√∫blica' √© obrigat√≥rio")
    private Boolean requiresPublicConsultation;
    
    @Min(value = 1, message = "Prazo m√°ximo deve ser pelo menos 1 dia")
    private Integer maxProcessingDays;
    
    // Configura√ß√µes Financeiras
    @NotNull(message = "Campo 'possui taxas' √© obrigat√≥rio")
    private Boolean hasFees;
    
    @DecimalMin(value = "0.0", message = "Taxa base deve ser maior ou igual a zero")
    private BigDecimal baseFee;
    
    private String currencyCode;
    
    // Configura√ß√µes Adicionais
    @Min(value = 0, message = "Ordem de classifica√ß√£o deve ser maior ou igual a zero")
    private Integer sortOrder;
    
    private Object metadata;
}
```

---

## 3. API REST - Opera√ß√µes CRUD

### 3.1 Listagem de Tipos de Licen√ßa

**Endpoint:** `GET /api/v1/license-types`

**Par√¢metros de Query:**
| Par√¢metro | Tipo | Obrigat√≥rio | Padr√£o | Descri√ß√£o |
|-----------|------|-------------|--------|-----------|
| categoryId | string | N√£o | - | ID da categoria para filtrar |
| sectorId | string | N√£o | - | ID do setor para filtrar |
| licensingModel | string | N√£o | - | Modelo de licenciamento |
| name | string | N√£o | - | Nome do tipo de licen√ßa ou termo de busca |
| code | string | N√£o | - | C√≥digo do tipo de licen√ßa |
| active | boolean | N√£o | true | Status ativo/inativo |
| renewable | boolean | N√£o | - | Se a licen√ßa √© renov√°vel |
| pageNumber | string | N√£o | "0" | N√∫mero da p√°gina |
| pageSize | string | N√£o | "20" | Tamanho da p√°gina |
| sort | string | N√£o | "name" | Campo de ordena√ß√£o (name, code, createdAt) |
| direction | string | N√£o | "ASC" | Dire√ß√£o da ordena√ß√£o (ASC/DESC) |

**Resposta de Sucesso (200):**
```json
{
  "pageNumber": 0,
  "pageSize": 20,
  "totalElements": 45,
  "totalPages": 3,
  "last": false,
  "first": true,
  "content": [
    {
      "id": "lt-001",
      "name": "Licen√ßa de Restaurante Categoria A",
      "description": "Licen√ßa para explora√ß√£o de restaurante com capacidade superior a 50 pessoas",
      "code": "LIC_REST_CAT_A",
      "categoryId": "cat-001",
      "categoryName": "Restaura√ß√£o",
      "categoryPath": "/Comercial/Restaura√ß√£o",
      "licensingModelKey": "STANDARD",
      "licensingModelName": "Licenciamento Padr√£o",
      "validityPeriod": 12,
      "validityUnitKey": "MONTHS",
      "validityUnitName": "Meses",
      "renewable": true,
      "autoRenewal": false,
      "requiresInspection": true,
      "requiresPublicConsultation": false,
      "maxProcessingDays": 30,
      "hasFees": true,
      "baseFee": 25000.00,
      "currencyCode": "CVE",
      "currencySymbol": "$",
      "active": true,
      "sortOrder": 1,
      "createdAt": "2025-01-15T10:00:00Z",
      "updatedAt": "2025-01-20T14:30:00Z",
      "metadata": {
        "minimumArea": 100,
        "maxCapacity": 200,
        "requiresFireSafety": true,
        "requiresHealthPermit": true,
        "allowsAlcohol": true,
        "parkingRequirement": "1 space per 10 seats"
      }
    }
  ]
}
```

### 3.2 Detalhes de Tipo de Licen√ßa

**Endpoint:** `GET /api/v1/license-types/{licenseTypeId}`

**Par√¢metros de Path:**
| Par√¢metro | Tipo | Descri√ß√£o |
|-----------|------|-----------|
| licenseTypeId | string | ID √∫nico do tipo de licen√ßa |

**Resposta de Sucesso (200):**
```json
{
  "id": "lt-001",
  "name": "Licen√ßa de Restaurante Categoria A",
  "description": "Licen√ßa para explora√ß√£o de restaurante com capacidade superior a 50 pessoas",
  "code": "LIC_REST_CAT_A",
  "category": {
    "id": "cat-001",
    "name": "Restaura√ß√£o",
    "code": "REST",
    "path": "/Comercial/Restaura√ß√£o",
    "sector": {
      "id": "sec-001",
      "name": "Comercial",
      "code": "COM"
    }
  },
  "licensingModel": {
    "key": "STANDARD",
    "name": "Licenciamento Padr√£o",
    "description": "Processo padr√£o com an√°lise completa"
  },
  "validity": {
    "period": 12,
    "unit": {
      "key": "MONTHS",
      "name": "Meses",
      "symbol": "M"
    },
    "renewable": true,
    "autoRenewal": false
  },
  "processing": {
    "requiresInspection": true,
    "requiresPublicConsultation": false,
    "maxProcessingDays": 30,
    "estimatedProcessingDays": 20
  },
  "financial": {
    "hasFees": true,
    "baseFee": 25000.00,
    "currency": {
      "code": "CVE",
      "name": "Escudo Cabo-verdiano",
      "symbol": "$"
    }
  },
  "status": {
    "active": true,
    "canBeActivated": true,
    "canBeDeactivated": true,
    "hasActiveApplications": true
  },
  "statistics": {
    "totalApplications": 156,
    "approvedApplications": 142,
    "pendingApplications": 8,
    "rejectedApplications": 6,
    "averageProcessingDays": 18.5
  },
  "metadata": {
    "minimumArea": 100,
    "maxCapacity": 200,
    "requiresFireSafety": true,
    "requiresHealthPermit": true,
    "allowsAlcohol": true,
    "parkingRequirement": "1 space per 10 seats",
    "operatingHours": {
      "weekdays": "06:00-24:00",
      "weekends": "06:00-02:00"
    },
    "specialRequirements": [
      "Licen√ßa de ru√≠do para m√∫sica ao vivo",
      "Certificado de seguran√ßa alimentar",
      "Plano de evacua√ß√£o aprovado"
    ]
  },
  "auditInfo": {
    "createdBy": "admin@gov.cv",
    "createdAt": "2025-01-15T10:00:00Z",
    "updatedBy": "manager@gov.cv",
    "updatedAt": "2025-01-20T14:30:00Z",
    "version": 3
  }
}
```

### 3.3 Cria√ß√£o de Tipo de Licen√ßa

**Endpoint:** `POST /api/v1/license-types`

**Payload de Requisi√ß√£o:**
```json
{
  "name": "Licen√ßa de Caf√© e Pastelaria",
  "description": "Licen√ßa para explora√ß√£o de caf√© com servi√ßo de pastelaria",
  "code": "LIC_CAFE_PAST",
  "categoryId": "cat-002",
  "licensingModelKey": "SIMPLIFIED",
  "validityPeriod": 24,
  "validityUnitKey": "MONTHS",
  "renewable": true,
  "autoRenewal": true,
  "requiresInspection": false,
  "requiresPublicConsultation": false,
  "maxProcessingDays": 15,
  "hasFees": true,
  "baseFee": 12000.00,
  "currencyCode": "CVE",
  "sortOrder": 5,
  "metadata": {
    "minimumArea": 30,
    "maxCapacity": 40,
    "requiresFireSafety": false,
    "requiresHealthPermit": true,
    "allowsAlcohol": false,
    "specialEquipment": [
      "Forno para pastelaria",
      "M√°quina de caf√© profissional",
      "Vitrine refrigerada"
    ]
  }
}
```

<<<<<<< HEAD
**Resposta de Sucesso (201):**
```json
{
  "id": "lt-025",
  "message": "Tipo de licen√ßa criado com sucesso",
  "code": "LIC_CAFE_PAST",
  "name": "Licen√ßa de Caf√© e Pastelaria",
  "active": true,
  "createdAt": "2025-01-25T09:15:00Z"
}
```

### 3.4 Atualiza√ß√£o de Tipo de Licen√ßa

**Endpoint:** `PUT /api/v1/license-types/{licenseTypeId}`
=======
### 4.6 Funcionalidades Suportadas

#### ‚úÖ **Opera√ß√µes CRUD Completas**

- Criar par√¢metros de licen√ßa com valida√ß√µes robustas
- Consultar par√¢metros por ID ou tipo de licen√ßa
- Atualizar configura√ß√µes de par√¢metros existentes
- Eliminar par√¢metros (com valida√ß√µes de integridade)

#### ‚úÖ **Filtros e Pesquisa**

- Filtrar por tipo de licen√ßa
- Filtrar por modelo de licenciamento
- Filtrar por status (ativo/inativo)
- Ordena√ß√£o por m√∫ltiplos campos
- Pagina√ß√£o configur√°vel

#### ‚úÖ **Valida√ß√µes e Regras de Neg√≥cio**

- Valida√ß√£o de unicidade (um par√¢metro por tipo de licen√ßa)
- Valida√ß√£o de consist√™ncia entre modelos e configura√ß√µes
- Valida√ß√£o de per√≠odos e limites temporais
- Valida√ß√£o de depend√™ncias entre par√¢metros

#### ‚úÖ **Integra√ß√£o com Sistema de Op√ß√µes**

- Unidades de validade din√¢micas (T_OPTIONS)
- Modelos de licen√ßa configur√°veis
- Status de par√¢metros gerenciados centralmente

#### ‚úÖ **Auditoria e Rastreabilidade**

- Registro de cria√ß√£o e modifica√ß√£o
- Identifica√ß√£o de usu√°rios respons√°veis
- Hist√≥rico de altera√ß√µes
- Timestamps autom√°ticos

#### ‚úÖ **Seguran√ßa**

- Autentica√ß√£o via JWT
- Autoriza√ß√£o baseada em roles
- Valida√ß√£o de entrada rigorosa
- Sanitiza√ß√£o de dados

## 5. Scripts de Migra√ß√£o

### 5.1 Flyway Migration - V001\_\_Create_License_Parameter_Table.sql

```sql
-- Criar tabela de par√¢metros de tipos de licen√ßa
CREATE TABLE t_license_parameter (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    license_type_id_fk UUID NOT NULL,
    validity_unit VARCHAR(20) NOT NULL,
    validity_period INTEGER NOT NULL CHECK (validity_period > 0),
    model VARCHAR(50) NOT NULL,
    provisional_validity INTEGER CHECK (provisional_validity > 0),
    definitive_license_validity INTEGER CHECK (definitive_license_validity > 0),
    provisional_default_period INTEGER CHECK (provisional_default_period > 0),
    definitive_default_period INTEGER CHECK (definitive_default_period > 0),
    provisional_renewal_period INTEGER CHECK (provisional_renewal_period > 0),
    max_provisional_renewal INTEGER CHECK (max_provisional_renewal >= 0),
    definitive_renewal_period INTEGER CHECK (definitive_renewal_period > 0),
    definitive_renewal_default_period INTEGER CHECK (definitive_renewal_default_period > 0),
    renewal_default_period INTEGER CHECK (renewal_default_period > 0),
    max_renewal_period INTEGER CHECK (max_renewal_period > 0),
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    vitality_flag BOOLEAN NOT NULL DEFAULT true,
    registration_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    closing_date TIMESTAMP WITH TIME ZONE,
    network_application_id_fk UUID,
    organization_id_fk UUID,
    user_id_fk UUID,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100) NOT NULL,
    updated_by VARCHAR(100) NOT NULL,

    CONSTRAINT fk_license_parameter_license_type
        FOREIGN KEY (license_type_id_fk) REFERENCES t_license_type(id) ON DELETE CASCADE,
    CONSTRAINT chk_closing_date_after_registration
        CHECK (closing_date IS NULL OR closing_date > registration_date),
    CONSTRAINT chk_provisional_model_validity
        CHECK (
            (model = 'PROVISIONAL_DEFINITIVE' AND provisional_validity IS NOT NULL) OR
            (model != 'PROVISIONAL_DEFINITIVE' AND provisional_validity IS NULL)
        ),
    CONSTRAINT chk_renewal_periods_consistency
        CHECK (
            max_renewal_period IS NULL OR
            renewal_default_period IS NULL OR
            max_renewal_period >= renewal_default_period
        )
);

-- Coment√°rios na tabela
COMMENT ON TABLE t_license_parameter IS 'Par√¢metros de configura√ß√£o para tipos de licen√ßa';
COMMENT ON COLUMN t_license_parameter.validity_unit IS 'Unidade de tempo para validade (DAYS, MONTHS, YEARS)';
COMMENT ON COLUMN t_license_parameter.model IS 'Modelo de licenciamento (PROVISIONAL_DEFINITIVE, DIRECT_DEFINITIVE, RENEWABLE_ONLY)';
COMMENT ON COLUMN t_license_parameter.provisional_validity IS 'Per√≠odo de validade da licen√ßa provis√≥ria (em unidades definidas)';
COMMENT ON COLUMN t_license_parameter.vitality_flag IS 'Flag indicando se o par√¢metro est√° ativo no sistema';
```

### 5.2 Flyway Migration - V002\_\_Create_License_Parameter_Indexes.sql

```sql
-- √çndices para performance
CREATE INDEX idx_license_parameter_license_type ON t_license_parameter(license_type_id_fk);
CREATE INDEX idx_license_parameter_status ON t_license_parameter(status) WHERE status = 'ACTIVE';
CREATE INDEX idx_license_parameter_created_at ON t_license_parameter(created_at DESC);
CREATE INDEX idx_license_parameter_type_status ON t_license_parameter(license_type_id_fk, status);
CREATE INDEX idx_license_parameter_model ON t_license_parameter(model);
CREATE INDEX idx_license_parameter_vitality ON t_license_parameter(vitality_flag) WHERE vitality_flag = true;
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)

**Payload de Requisi√ß√£o:** (Mesmo formato da cria√ß√£o)

**Resposta de Sucesso (200):**
```json
{
  "id": "lt-025",
  "message": "Tipo de licen√ßa atualizado com sucesso",
  "code": "LIC_CAFE_PAST",
  "name": "Licen√ßa de Caf√© e Pastelaria Premium",
  "version": 2,
  "updatedAt": "2025-01-25T15:30:00Z"
}
```

<<<<<<< HEAD
<<<<<<< HEAD
### 3.5 Ativa√ß√£o e Desativa√ß√£o

#### 3.5.1 Ativa√ß√£o
**Endpoint:** `PATCH /api/v1/license-types/{licenseTypeId}/ativar`

**Resposta de Sucesso (200):**
```json
{
  "message": "Tipo de licen√ßa ativado com sucesso",
  "licenseTypeId": "lt-025",
  "code": "LIC_CAFE_PAST",
  "name": "Licen√ßa de Caf√© e Pastelaria",
  "status": "active",
  "activatedAt": "2025-01-25T16:00:00Z",
  "activatedBy": "admin@gov.cv"
}
```

#### 3.5.2 Desativa√ß√£o
**Endpoint:** `PATCH /api/v1/license-types/{licenseTypeId}/desativar`

**Resposta de Sucesso (200):**
```json
{
  "message": "Tipo de licen√ßa desativado com sucesso",
  "licenseTypeId": "lt-025",
  "code": "LIC_CAFE_PAST",
  "name": "Licen√ßa de Caf√© e Pastelaria",
  "status": "inactive",
  "deactivatedAt": "2025-01-25T16:30:00Z",
  "deactivatedBy": "admin@gov.cv",
  "impact": {
    "pendingApplications": 3,
    "activeApplications": 12,
    "action": "Solicita√ß√µes pendentes ser√£o mantidas, novas solicita√ß√µes n√£o ser√£o aceitas"
  }
}
```

---
=======
=======
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)
### 5.3 Flyway Migration - V003\_\_Create_License_Parameter_Triggers.sql

```sql
-- Trigger para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_license_parameter_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_license_parameter_updated_at
    BEFORE UPDATE ON t_license_parameter
    FOR EACH ROW
    EXECUTE FUNCTION update_license_parameter_updated_at();

-- Trigger para valida√ß√£o de consist√™ncia de dados
CREATE OR REPLACE FUNCTION validate_license_parameter_consistency()
RETURNS TRIGGER AS $$
BEGIN
    -- Validar que par√¢metros provis√≥rios s√≥ existem para modelo PROVISIONAL_DEFINITIVE
    IF NEW.model != 'PROVISIONAL_DEFINITIVE' AND (
        NEW.provisional_validity IS NOT NULL OR
        NEW.provisional_default_period IS NOT NULL OR
        NEW.provisional_renewal_period IS NOT NULL OR
        NEW.max_provisional_renewal IS NOT NULL
    ) THEN
        RAISE EXCEPTION 'Provisional parameters only allowed for PROVISIONAL_DEFINITIVE model';
    END IF;

    -- Validar que modelo PROVISIONAL_DEFINITIVE tem par√¢metros obrigat√≥rios
    IF NEW.model = 'PROVISIONAL_DEFINITIVE' AND NEW.provisional_validity IS NULL THEN
        RAISE EXCEPTION 'Provisional validity is required for PROVISIONAL_DEFINITIVE model';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_license_parameter_consistency
    BEFORE INSERT OR UPDATE ON t_license_parameter
    FOR EACH ROW
    EXECUTE FUNCTION validate_license_parameter_consistency();
```

### 6.4 Dados Iniciais t_options - V004\_\_Insert_License_Parameter_Options.sql

```sql
-- Inserir op√ß√µes para STATUS de par√¢metros de licen√ßa
INSERT INTO t_options (ccode, ckey, cvalue, locale, sort_order, active, description, created_by, updated_by)
VALUES
    ('LICENSE_PARAMETER_STATUS', 'ACTIVE', 'Ativo', 'pt_CV', 1, true, 'Par√¢metro ativo e em uso', 'SYSTEM', 'SYSTEM'),
    ('LICENSE_PARAMETER_STATUS', 'INACTIVE', 'Inativo', 'pt_CV', 2, true, 'Par√¢metro inativo', 'SYSTEM', 'SYSTEM'),
    ('LICENSE_PARAMETER_STATUS', 'DRAFT', 'Rascunho', 'pt_CV', 3, true, 'Par√¢metro em rascunho', 'SYSTEM', 'SYSTEM')
ON CONFLICT (ccode, ckey, locale) DO NOTHING;

-- Inserir op√ß√µes para UNIDADES DE VALIDADE
INSERT INTO t_options (ccode, ckey, cvalue, locale, sort_order, active, description, created_by, updated_by)
VALUES
    ('VALIDITY_UNIT', 'DAYS', 'Dias', 'pt_CV', 1, true, 'Validade em dias', 'SYSTEM', 'SYSTEM'),
    ('VALIDITY_UNIT', 'MONTHS', 'Meses', 'pt_CV', 2, true, 'Validade em meses', 'SYSTEM', 'SYSTEM'),
    ('VALIDITY_UNIT', 'YEARS', 'Anos', 'pt_CV', 3, true, 'Validade em anos', 'SYSTEM', 'SYSTEM')
ON CONFLICT (ccode, ckey, locale) DO NOTHING;

-- Inserir op√ß√µes para MODELOS DE LICEN√áA
INSERT INTO t_options (ccode, ckey, cvalue, locale, sort_order, active, description, created_by, updated_by)
VALUES
    ('LICENSE_MODEL', 'PROVISIONAL_DEFINITIVE', 'Provis√≥ria/Definitiva', 'pt_CV', 1, true, 'Modelo com fase provis√≥ria seguida de definitiva', 'SYSTEM', 'SYSTEM'),
    ('LICENSE_MODEL', 'DIRECT_DEFINITIVE', 'Definitiva Direta', 'pt_CV', 2, true, 'Modelo definitivo direto sem fase provis√≥ria', 'SYSTEM', 'SYSTEM'),
    ('LICENSE_MODEL', 'RENEWABLE_ONLY', 'Apenas Renov√°vel', 'pt_CV', 3, true, 'Modelo que permite apenas renova√ß√µes', 'SYSTEM', 'SYSTEM')
ON CONFLICT (ccode, ckey, locale) DO NOTHING;
```

### 6.5 Dados Iniciais - V005\_\_Insert_License_Parameter_Sample_Data.sql
<<<<<<< HEAD
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)
=======
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)

## 4. Regras de Neg√≥cio Espec√≠ficas

<<<<<<< HEAD
### 4.1 Valida√ß√µes de Integridade
=======
-- Par√¢metro para Licen√ßa de Com√©rcio Geral (modelo provis√≥rio + definitivo)
INSERT INTO t_license_parameter (
    license_type_id_fk,
    validity_unit,
    validity_period,
    model,
    provisional_validity,
    definitive_license_validity,
    provisional_default_period,
    definitive_default_period,
    max_provisional_renewal,
    renewal_default_period,
    max_renewal_period,
    status,
    created_by,
    updated_by
) VALUES (
    (SELECT id FROM t_license_type WHERE name = 'Licen√ßa de Com√©rcio Geral' LIMIT 1),
    'YEARS',
    1,
    'PROVISIONAL_DEFINITIVE',
    6, -- 6 meses provis√≥ria
    12, -- 1 ano definitiva
    6,
    12,
    2, -- m√°ximo 2 renova√ß√µes provis√≥rias
    12,
    60, -- m√°ximo 5 anos de renova√ß√£o
    'ACTIVE',
    'SYSTEM',
    'SYSTEM'
) ON CONFLICT DO NOTHING;

-- Par√¢metro para Licen√ßa Industrial (modelo definitivo direto)
INSERT INTO t_license_parameter (
    license_type_id_fk,
    validity_unit,
    validity_period,
    model,
    definitive_license_validity,
    definitive_default_period,
    renewal_default_period,
    max_renewal_period,
    status,
    created_by,
    updated_by
) VALUES (
    (SELECT id FROM t_license_type WHERE name = 'Licen√ßa Industrial' LIMIT 1),
    'YEARS',
    2,
    'DIRECT_DEFINITIVE',
    24, -- 2 anos
    24,
    24,
    120, -- m√°ximo 10 anos de renova√ß√£o
    'ACTIVE',
    'SYSTEM',
    'SYSTEM'
) ON CONFLICT DO NOTHING;

-- Par√¢metro para Licen√ßa de Servi√ßos (modelo apenas renov√°vel)
INSERT INTO t_license_parameter (
    license_type_id_fk,
    validity_unit,
    validity_period,
    model,
    renewal_default_period,
    max_renewal_period,
    status,
    created_by,
    updated_by
) VALUES (
    (SELECT id FROM t_license_type WHERE name = 'Licen√ßa de Servi√ßos' LIMIT 1),
    'MONTHS',
    12,
    'RENEWABLE_ONLY',
    12,
    60, -- m√°ximo 5 anos
    'ACTIVE',
    'SYSTEM',
    'SYSTEM'
) ON CONFLICT DO NOTHING;
```

## 6. Testes

### 6.1 Testes Unit√°rios
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)

#### 4.1.1 Valida√ß√µes de Cria√ß√£o
```java
// Valida√ß√£o customizada para autoRenewal
@AssertTrue(message = "Auto renova√ß√£o s√≥ √© permitida se a licen√ßa for renov√°vel")
public boolean isAutoRenewalValid() {
    return !Boolean.TRUE.equals(autoRenewal) || Boolean.TRUE.equals(renewable);
}

// Valida√ß√£o customizada para baseFee
@AssertTrue(message = "Taxa base √© obrigat√≥ria quando hasFees √© verdadeiro")
public boolean isBaseFeeValid() {
    return !Boolean.TRUE.equals(hasFees) || (baseFee != null && baseFee.compareTo(BigDecimal.ZERO) >= 0);
}

// Valida√ß√£o customizada para currencyCode
@AssertTrue(message = "C√≥digo da moeda √© obrigat√≥rio quando h√° taxas")
public boolean isCurrencyCodeValid() {
    return !Boolean.TRUE.equals(hasFees) || (currencyCode != null && !currencyCode.trim().isEmpty());
}
```

#### 4.1.2 Valida√ß√µes de Atualiza√ß√£o
- N√£o √© poss√≠vel alterar o c√≥digo ap√≥s cria√ß√£o
- N√£o √© poss√≠vel alterar a categoria se existirem solicita√ß√µes ativas
- Altera√ß√µes em taxas s√≥ afetam novas solicita√ß√µes
- Altera√ß√µes em prazos s√≥ afetam solicita√ß√µes futuras

### 4.2 Regras de Status

#### 4.2.1 Ativa√ß√£o
- Categoria deve estar ativa
- Setor da categoria deve estar ativo
- Todas as refer√™ncias (OPTIONS) devem existir
- N√£o pode haver outro tipo com mesmo c√≥digo ativo

#### 4.2.2 Desativa√ß√£o
- Solicita√ß√µes pendentes continuam processamento
- Novas solicita√ß√µes s√£o bloqueadas
- Renova√ß√µes de licen√ßas existentes continuam permitidas
- Hist√≥rico √© mantido para auditoria

### 4.3 Regras de Metadados

#### 4.3.1 Estrutura Padr√£o
```json
{
  "physical": {
    "minimumArea": 50,
    "maxCapacity": 100,
    "parkingSpaces": 10,
    "accessibilityRequired": true
  },
  "operational": {
    "operatingHours": {
      "weekdays": "06:00-22:00",
      "weekends": "08:00-24:00"
    },
    "seasonalOperation": false,
    "allowsDelivery": true
  },
  "regulatory": {
    "requiresFireSafety": true,
    "requiresHealthPermit": true,
    "requiresEnvironmentalLicense": false,
    "allowsAlcohol": true,
    "allowsMusic": false
  },
  "financial": {
    "minimumCapital": 500000.00,
    "insuranceRequired": true,
    "guaranteeRequired": false
  },
  "technical": {
    "requiredEquipment": [],
    "technicalStandards": [],
    "certificationRequired": []
  }
}
```

---

## 5. Casos de Uso Espec√≠ficos

### 5.1 UC001 - Criar Tipo de Licen√ßa Simples
**Cen√°rio:** Caf√© sem √°lcool, processo simplificado

**Dados:**
- Modelo: SIMPLIFIED
- Validade: 24 meses
- Renova√ß√£o: Autom√°tica
- Inspe√ß√£o: N√£o requerida
- Taxa: 8.000 CVE

### 5.2 UC002 - Criar Tipo de Licen√ßa Complexa
**Cen√°rio:** Restaurante com √°lcool, processo padr√£o

**Dados:**
- Modelo: STANDARD
- Validade: 12 meses
- Renova√ß√£o: Manual
- Inspe√ß√£o: Requerida
- Consulta p√∫blica: Requerida
- Taxa: 25.000 CVE

### 5.3 UC003 - Migrar Tipo de Licen√ßa
**Cen√°rio:** Mudan√ßa de categoria por reestrutura√ß√£o

**Fluxo:**
1. Verificar impactos em solicita√ß√µes ativas
2. Criar novo tipo na categoria destino
3. Migrar configura√ß√µes e metadados
4. Desativar tipo original
5. Redirecionar novas solicita√ß√µes

---

## 6. Tratamento de Erros Espec√≠ficos

### 6.1 Erros de Valida√ß√£o

#### 6.1.1 C√≥digo Duplicado (409)
```json
{
  "type": "https://api.gov.cv/problems/duplicate-code",
  "title": "C√≥digo duplicado",
  "status": 409,
  "detail": "J√° existe um tipo de licen√ßa com o c√≥digo 'LIC_REST_001'",
  "instance": "/api/v1/license-types",
  "timestamp": "2025-01-25T10:30:00Z",
  "errors": {
    "code": "C√≥digo 'LIC_REST_001' j√° est√° em uso pelo tipo 'Licen√ßa de Restaurante B√°sico' (ID: lt-005)"
  }
}
```

#### 6.1.2 Categoria Inv√°lida (400)
```json
{
  "type": "https://api.gov.cv/problems/invalid-reference",
  "title": "Refer√™ncia inv√°lida",
  "status": 400,
  "detail": "Categoria especificada n√£o existe ou est√° inativa",
  "instance": "/api/v1/license-types",
  "timestamp": "2025-01-25T10:30:00Z",
  "errors": {
    "categoryId": "Categoria 'cat-999' n√£o encontrada ou est√° inativa"
  }
}
```

#### 6.1.3 Configura√ß√£o Inconsistente (400)
```json
{
  "type": "https://api.gov.cv/problems/invalid-configuration",
  "title": "Configura√ß√£o inv√°lida",
  "status": 400,
  "detail": "Configura√ß√£o de renova√ß√£o autom√°tica inconsistente",
  "instance": "/api/v1/license-types",
  "timestamp": "2025-01-25T10:30:00Z",
  "errors": {
    "autoRenewal": "Auto renova√ß√£o s√≥ pode ser ativada se a licen√ßa for renov√°vel",
    "baseFee": "Taxa base √© obrigat√≥ria quando hasFees √© verdadeiro"
  }
}
```

---

## 7. Integra√ß√µes com Outros M√≥dulos

### 7.1 Depend√™ncias Diretas
- **Categorias**: Valida√ß√£o de categoria ativa
- **Op√ß√µes**: Valida√ß√£o de chaves de refer√™ncia
- **Par√¢metros**: Configura√ß√µes espec√≠ficas do tipo
- **Legisla√ß√µes**: Legisla√ß√µes aplic√°veis
- **Entidades**: Entidades envolvidas no processo

### 7.2 M√≥dulos Dependentes
- **Solicita√ß√µes**: Utilizam configura√ß√µes do tipo
- **Processos**: Seguem regras definidas no tipo
- **Taxas**: Calculam valores baseados no tipo
- **Relat√≥rios**: Agrupam dados por tipo

---

## 8. Auditoria e Versionamento

### 8.1 Campos de Auditoria
```java
@CreatedDate
private LocalDateTime createdAt;

@CreatedBy
private String createdBy;

@LastModifiedDate
private LocalDateTime updatedAt;

@LastModifiedBy
private String updatedBy;

@Version
private Long version;
```

### 8.2 Hist√≥rico de Altera√ß√µes
- Todas as altera√ß√µes s√£o registradas
- Versioning autom√°tico para controle de concorr√™ncia
- Log detalhado de mudan√ßas em campos cr√≠ticos
- Backup autom√°tico antes de altera√ß√µes estruturais

---

## 9. Performance e Otimiza√ß√£o

### 9.1 √çndices Recomendados
```sql
CREATE INDEX idx_license_type_code ON license_types(code);
CREATE INDEX idx_license_type_category ON license_types(category_id);
CREATE INDEX idx_license_type_active ON license_types(active);
CREATE INDEX idx_license_type_name ON license_types(name);
CREATE INDEX idx_license_type_licensing_model ON license_types(licensing_model_key);
```

### 9.2 Cache Strategy
- Cache de tipos ativos por categoria
- Cache de configura√ß√µes frequentemente acessadas
- Invalida√ß√£o autom√°tica em altera√ß√µes
- TTL configur√°vel por ambiente

<<<<<<< HEAD
Este documento estabelece as bases para a gest√£o completa dos dados gerais dos tipos de licen√ßa, garantindo flexibilidade, consist√™ncia e rastreabilidade em todas
=======
### 8.1 Configura√ß√£o OpenAPI

```java
@Configuration
@OpenAPIDefinition(
    info = @Info(
        title = "License Parameter API",
        version = "1.0",
        description = "API para gest√£o de par√¢metros de tipos de licen√ßa"
    )
)
public class LicenseParameterOpenApiConfig {

    @Bean
    public GroupedOpenApi licenseParameterApi() {
        return GroupedOpenApi.builder()
            .group("license-parameters")
            .pathsToMatch("/api/v1/license-parameters/**")
            .build();
    }
}
```

### 8.2 Documenta√ß√£o dos Endpoints

```java
@Tag(name = "License Parameters", description = "Gest√£o de par√¢metros de tipos de licen√ßa")
@RestController
public class LicenseParameterController {

    @Operation(
        summary = "Criar par√¢metro de tipo de licen√ßa",
        description = "Cria um novo conjunto de par√¢metros para um tipo de licen√ßa espec√≠fico"
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = "201", description = "Par√¢metro criado com sucesso"),
        @ApiResponse(responseCode = "400", description = "Dados inv√°lidos"),
        @ApiResponse(responseCode = "409", description = "Tipo de licen√ßa j√° possui par√¢metros")
    })
    @PostMapping
    public ResponseEntity<LicenseParameterResponse> create(
            @Parameter(description = "Dados do par√¢metro a criar")
            @Valid @RequestBody CreateLicenseParameterRequest request) {
        // implementa√ß√£o
    }

    @Operation(
        summary = "Obter par√¢metro por ID",
        description = "Retorna os detalhes de um par√¢metro espec√≠fico"
    )
    @GetMapping("/{id}")
    public ResponseEntity<LicenseParameterResponse> getById(
            @Parameter(description = "ID do par√¢metro") @PathVariable UUID id) {
        // implementa√ß√£o
    }
}
```

## 9. Conclus√£o

Este documento especifica a implementa√ß√£o completa do m√≥dulo de **Parametriza√ß√£o de Tipos de Licen√ßa** para o Sistema de Licenciamento de Cabo Verde. A solu√ß√£o:

### ‚úÖ **Caracter√≠sticas Principais:**

- **Modelo normalizado** com a tabela `T_LICENSE_PARAMETER`

- **Arquitetura DDD** robusta com separa√ß√£o clara de responsabilidades

- **APIs REST** completas para todas as opera√ß√µes CRUD

- **Valida√ß√µes abrangentes** de regras de neg√≥cio

- **Suporte a m√∫ltiplos modelos** de licenciamento

- **Flexibilidade** para diferentes unidades de tempo e per√≠odos

### üîß **Funcionalidades Implementadas:**

- Gest√£o de par√¢metros de validade (dias, meses, anos)

- Configura√ß√£o de licen√ßas provis√≥rias e definitivas

- Gest√£o de per√≠odos de renova√ß√£o

- Valida√ß√µes de consist√™ncia e integridade

- Auditoria completa de opera√ß√µes

- M√©tricas e monitoriza√ß√£o

### üìä **Qualidade e Testes:**

- Testes unit√°rios abrangentes com cobertura > 90%
- Testes de integra√ß√£o com TestContainers
- Valida√ß√µes de dom√≠nio robustas
- Testes de performance e carga

### üöÄ **Benef√≠cios da Implementa√ß√£o:**

- **Flexibilidade**: Suporte a diferentes modelos de licenciamento
- **Consist√™ncia**: Valida√ß√µes rigorosas garantem integridade dos dados
- **Escalabilidade**: Arquitetura preparada para crescimento
- **Manutenibilidade**: C√≥digo limpo seguindo princ√≠pios DDD
- **Observabilidade**: M√©tricas e logs detalhados

### üìã **Pr√≥ximos Passos:**

1. Implementar integra√ß√£o com m√≥dulo de licen√ßas ativas
2. Adicionar notifica√ß√µes autom√°ticas de vencimento
3. Desenvolver relat√≥rios de utiliza√ß√£o de par√¢metros
4. Implementar cache distribu√≠do para alta performance
5. Adicionar suporte a workflows de aprova√ß√£o

---

**Documento gerado em:** $(date)
**Vers√£o:** 1.0
**Status:** Especifica√ß√£o Completa
>>>>>>> parent of 2bd9194 (refactor(database): standardize timestamp column names to created_date and last_modified_date)
