# Especificação Técnica e Funcional - Associação Categoria CAE

## Sistema de Gestão de Associações CAE de Cabo Verde

## 1. Visão Geral do Módulo

O módulo de **Associação Categoria CAE** é um componente especializado do sistema que permite a gestão de associações entre códigos CAE (Classificação das Atividades Económicas) e categorias de licenciamento. Este módulo centraliza o mapeamento entre atividades económicas e suas respetivas categorias regulamentares, garantindo integridade e unicidade dos dados.

### 1.1 Objetivos

* Permitir associação múltipla de códigos CAE às categorias existentes

* Garantir integridade e unicidade dos dados de associação

* Fornecer APIs REST para operações CRUD completas

* Implementar validações robustas de negócio

* Integrar com a arquitetura DDD existente do sistema

* Assegurar performance através de cache inteligente e índices otimizados

### 1.2 Casos de Uso Principais

* **Gestão de Associações**: CRUD completo de associações CAE-Categoria

* **Consulta por Categoria**: Obter todos os códigos CAE associados a uma categoria

* **Validação de Códigos**: Verificar existência e formato de códigos CAE

* **Controlo de Duplicação**: Impedir códigos CAE duplicados por categoria

## 2. Modelo de Dados

### 2.1 Estrutura da Tabela T\_CATEGORY\_CLASSIFICATION

```sql
CREATE TABLE T_CATEGORY_CLASSIFICATION (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category_id_fk UUID NOT NULL,                    -- FK para T_LICENSE_CATEGORY
    cae_code VARCHAR(10) NOT NULL,                   -- Código CAE (5 dígitos)
    description TEXT NOT NULL,                       -- Descrição da atividade
    active BOOLEAN DEFAULT TRUE,                     -- Status ativo/inativo
    metadata JSONB,                                  -- Metadados adicionais
    created_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_modified_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by VARCHAR(100),
    last_modified_by VARCHAR(100),
    
    -- Constraints
    CONSTRAINT fk_category_classification_category 
        FOREIGN KEY (category_id_fk) REFERENCES T_LICENSE_CATEGORY(id),
    CONSTRAINT chk_cae_code_format 
        CHECK (cae_code ~ '^[0-9]{5}$'),
    CONSTRAINT chk_description_length 
        CHECK (LENGTH(description) >= 10 AND LENGTH(description) <= 500)
);

-- Índices para performance
CREATE UNIQUE INDEX idx_category_classification_unique 
    ON T_CATEGORY_CLASSIFICATION(category_id_fk, cae_code) 
    WHERE active = true;
CREATE INDEX idx_category_classification_category_id 
    ON T_CATEGORY_CLASSIFICATION(category_id_fk);
CREATE INDEX idx_category_classification_cae_code 
    ON T_CATEGORY_CLASSIFICATION(cae_code);
CREATE INDEX idx_category_classification_active 
    ON T_CATEGORY_CLASSIFICATION(active);
CREATE INDEX idx_category_classification_category_active 
    ON T_CATEGORY_CLASSIFICATION(category_id_fk, active);
```

### 2.2 Exemplos de Dados

```sql
-- Associações para Categoria de Restauração
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active) VALUES
('550e8400-e29b-41d4-a716-446655440001', '56101', 'Restaurantes com serviço de mesa', true),
('550e8400-e29b-41d4-a716-446655440001', '56102', 'Restaurantes sem serviço de mesa', true),
('550e8400-e29b-41d4-a716-446655440001', '56103', 'Restaurantes com esplanada', true);

-- Associações para Categoria de Comércio
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active, metadata) VALUES
('550e8400-e29b-41d4-a716-446655440002', '47111', 'Comércio a retalho em supermercados', true, '{"min_area": 400}'),
('550e8400-e29b-41d4-a716-446655440002', '47112', 'Comércio a retalho em hipermercados', true, '{"min_area": 2500}'),
('550e8400-e29b-41d4-a716-446655440002', '47191', 'Comércio a retalho não especializado', true, '{"max_area": 399}');

-- Associações para Categoria de Turismo
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active) VALUES
('550e8400-e29b-41d4-a716-446655440003', '55111', 'Hotéis com restaurante', true),
('550e8400-e29b-41d4-a716-446655440003', '55112', 'Hotéis sem restaurante', true),
('550e8400-e29b-41d4-a716-446655440003', '55201', 'Alojamento turístico em espaço rural', true);
```

## 3. Arquitetura DDD

### 3.1 Estrutura de Camadas

```
src/main/java/cv/gov/licensing/
├── domain/
│   └── categoryassociation/
│       ├── CategoryCAEAssociation.java           # Aggregate Root
│       ├── CategoryCAEAssociationId.java        # Value Object
│       ├── CategoryId.java                      # Value Object
│       ├── CAECode.java                         # Value Object
│       ├── ActivityDescription.java             # Value Object
│       ├── CategoryCAEAssociationRepository.java # Repository Interface
│       └── CategoryCAEDomainService.java
├── application/
│   └── categoryassociation/
│       ├── usecase/
│       │   ├── GetAssociationsByCategoryUseCase.java
│       │   ├── CreateCAEAssociationsUseCase.java
│       │   ├── UpdateCAEAssociationsUseCase.java
│       │   └── DeleteCAEAssociationUseCase.java
│       ├── service/
│       │   └── CategoryCAEApplicationService.java
│       └── port/
│           ├── in/
│           │   └── CategoryCAEUseCasePort.java
│           └── out/
│               ├── CategoryCAERepositoryPort.java
│               └── CategoryCAECachePort.java
├── interfaces/
│   └── rest/
│       ├── CategoryCAEController.java
│       └── dto/
│           ├── CategoryCAEAssociationResponse.java
│           ├── CategoryCAEListResponse.java
│           ├── CreateCAEAssociationRequest.java
│           └── UpdateCAEAssociationRequest.java
└── infrastructure/
    ├── persistence/
    │   ├── CategoryCAEJpaEntity.java
    │   ├── CategoryCAEJpaRepository.java
    │   └── CategoryCAERepositoryAdapter.java
    └── cache/
        └── CategoryCAECacheService.java
```

### 3.2 Domain Layer - Entidades e Value Objects

```java
// CategoryCAEAssociation.java - Aggregate Root
@Entity
public class CategoryCAEAssociation {
    private CategoryCAEAssociationId id;
    private CategoryId categoryId;
    private CAECode caeCode;
    private ActivityDescription description;
    private Boolean active;
    private Map<String, Object> metadata;
    private AuditInfo auditInfo;

    // Factory Method
    public static CategoryCAEAssociation create(CategoryId categoryId, CAECode caeCode,
                                              ActivityDescription description) {
        var association = new CategoryCAEAssociation();
        association.id = CategoryCAEAssociationId.generate();
        association.categoryId = Objects.requireNonNull(categoryId, "ID da categoria é obrigatório");
        association.caeCode = Objects.requireNonNull(caeCode, "Código CAE é obrigatório");
        association.description = Objects.requireNonNull(description, "Descrição é obrigatória");
        association.active = true;
        association.auditInfo = AuditInfo.create();
        return association;
    }

    // Business Methods
    public void updateDescription(ActivityDescription newDescription) {
        this.description = Objects.requireNonNull(newDescription, "Descrição é obrigatória");
        this.auditInfo = this.auditInfo.update();
    }

    public void deactivate() {
        this.active = false;
        this.auditInfo = this.auditInfo.update();
    }

    public void reactivate() {
        this.active = true;
        this.auditInfo = this.auditInfo.update();
    }

    public boolean isActive() {
        return Boolean.TRUE.equals(this.active);
    }

    public void updateMetadata(Map<String, Object> newMetadata) {
        this.metadata = newMetadata != null ? new HashMap<>(newMetadata) : null;
        this.auditInfo = this.auditInfo.update();
    }
}

// CAECode.java - Value Object
public class CAECode {
    private final String value;

    private CAECode(String value) {
        if (value == null || value.trim().isEmpty()) {
            throw new IllegalArgumentException("Código CAE não pode ser vazio");
        }
        if (!value.matches("^[0-9]{5}$")) {
            throw new IllegalArgumentException("Código CAE deve conter exatamente 5 dígitos numéricos");
        }
        this.value = value.trim();
    }

    public static CAECode of(String value) {
        return new CAECode(value);
    }

    public String getValue() {
        return value;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        CAECode caeCode = (CAECode) o;
        return Objects.equals(value, caeCode.value);
    }

    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
}

// ActivityDescription.java - Value Object
public class ActivityDescription {
    private final String value;

    private ActivityDescription(String value) {
        if (value == null || value.trim().isEmpty()) {
            throw new IllegalArgumentException("Descrição da atividade não pode ser vazia");
        }
        if (value.length() < 10 || value.length() > 500) {
            throw new IllegalArgumentException("Descrição deve ter entre 10 e 500 caracteres");
        }
        this.value = value.trim();
    }

    public static ActivityDescription of(String value) {
        return new ActivityDescription(value);
    }

    public String getValue() {
        return value;
    }
}
```

## 4. APIs REST

### 4.1 Endpoints de Consulta

#### GET /api/v1/categories/{categoryId}/cae

Obter todas as associações CAE de uma categoria específica.

**Parâmetros:**

* `categoryId` (path): UUID da categoria

* `page` (query, opcional): Página (default: 0)

* `size` (query, opcional): Itens por página (default: 20, max: 100)

* `active` (query, opcional): Filtro por status (default: true)

* `sort` (query, opcional): Ordenação (ex: caeCode,asc)

**Resposta (200):**

```json
{
  "categoryId": "550e8400-e29b-41d4-a716-446655440001",
  "content": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "categoryId": "550e8400-e29b-41d4-a716-446655440001",
      "caeCode": "56101",
      "description": "Restaurantes com serviço de mesa",
      "active": true,
      "metadata": null,
      "createdDate": "2024-01-15T10:30:00Z",
      "lastModifiedDate": "2024-01-15T10:30:00Z"
    }
  ],
  "pageable": {
    "page": 0,
    "size": 20,
    "sort": "caeCode,asc"
  },
  "totalElements": 15,
  "totalPages": 1,
  "first": true,
  "last": true
}
```

#### GET /api/v1/categories/cae

Obter associações CAE de múltiplas categorias numa única chamada.

**Parâmetros:**

* `categoryIds` (query): Lista de UUIDs separados por vírgula

* `active` (query, opcional): Filtro por status (default: true)

**Resposta:**

```json
{
  "associations": {
    "550e8400-e29b-41d4-a716-446655440001": [
      {
        "id": "123e4567-e89b-12d3-a456-426614174000",
        "caeCode": "56101",
        "description": "Restaurantes com serviço de mesa",
        "active": true
      }
    ],
    "550e8400-e29b-41d4-a716-446655440002": [
      {
        "id": "123e4567-e89b-12d3-a456-426614174001",
        "caeCode": "47111",
        "description": "Comércio a retalho em supermercados",
        "active": true
      }
    ]
  }
}
```

### 4.2 Endpoints de Gestão (Administrativos)

#### POST /api/v1/categories/{categoryId}/cae

Criar múltiplas associações CAE para uma categoria.

**Request Body:**

```json
{
  "associations": [
    {
      "caeCode": "56104",
      "description": "Restaurantes de comida rápida",
      "active": true,
      "metadata": {
        "serviceType": "fast_food",
        "minSeats": 10
      }
    },
    {
      "caeCode": "56105",
      "description": "Bares e cafés",
      "active": true,
      "metadata": {
        "hasAlcohol": true
      }
    }
  ]
}
```

#### PUT /api/v1/categories/{categoryId}/cae

Atualizar completamente as associações de uma categoria (substituição).

#### PUT /api/v1/categories/{categoryId}/cae/{associationId}

Atualizar uma associação específica.

#### DELETE /api/v1/categories/{categoryId}/cae/{associationId}

Eliminar uma associação (soft delete).

#### GET /api/v1/categories/cae/admin

Listar todas as associações com filtros avançados e paginação (administrativo).

**Parâmetros:**

* `categoryId` (query, opcional): Filtrar por categoria

* `caeCode` (query, opcional): Filtrar por código CAE

* `active` (query, opcional): Filtrar por status

* `page` (query, opcional): Página (default: 0)

* `size` (query, opcional): Tamanho da página (default: 20)

* `sort` (query, opcional): Ordenação

## 5. Casos de Uso Detalhados

### 5.1 UC001 - Consultar Associações CAE por Categoria

**Ator:** Sistema/Frontend
**Pré-condições:** Categoria existe no sistema
**Fluxo Principal:**

1. Sistema solicita associações CAE para uma categoria específica
2. Sistema verifica cache para a categoria
3. Se não existe em cache, consulta base de dados
4. Filtra associações ativas e aplica paginação
5. Armazena resultado em cache
6. Retorna lista de associações formatada

**Fluxos Alternativos:**

* 2a. Categoria não existe: retorna erro 404

* 3a. Erro de base de dados: retorna erro 500

### 5.2 UC002 - Criar Associações CAE

**Ator:** Administrador do Sistema
**Pré-condições:** Utilizador autenticado com role ADMIN
**Fluxo Principal:**

1. Administrador submete lista de associações CAE
2. Sistema valida formato dos códigos CAE
3. Sistema verifica se categoria existe
4. Sistema valida unicidade dos códigos CAE na categoria
5. Sistema persiste novas associações
6. Sistema invalida cache relacionado
7. Sistema retorna associações criadas

**Regras de Negócio:**

* Não permitir códigos CAE duplicados na mesma categoria

* Validar formato do código CAE (5 dígitos numéricos)

* Validar tamanho da descrição (10-500 caracteres)

* Manter auditoria de todas as alterações

### 5.3 UC003 - Atualizar Associações CAE

**Ator:** Administrador do Sistema
**Pré-condições:** Utilizador autenticado com role ADMIN
**Fluxo Principal:**

1. Administrador submete alterações às associações
2. Sistema valida dados de entrada
3. Sistema verifica existência das associações
4. Sistema aplica alterações (transacional)
5. Sistema invalida cache relacionado
6. Sistema retorna associações atualizadas

### 5.4 UC004 - Eliminar Associação CAE

**Ator:** Administrador do Sistema
**Pré-condições:** Utilizador autenticado com role ADMIN
**Fluxo Principal:**

1. Administrador solicita eliminação de associação
2. Sistema verifica existência da associação
3. Sistema marca associação como inativa (soft delete)
4. Sistema invalida cache relacionado
5. Sistema confirma eliminação

## 6. Validações e Regras de Negócio

### 6.1 Validações de Domínio

```java
// Validações na entidade CategoryCAEAssociation
public class CategoryCAEAssociation {
    
    private void validateUniqueConstraint(CategoryId categoryId, CAECode caeCode) {
        // Validação de unicidade será feita no repositório
    }

    private void validateCAECodeFormat(CAECode caeCode) {
        String value = caeCode.getValue();
        if (!value.matches("^[0-9]{5}$")) {
            throw new BusinessRuleException(
                "Código CAE deve conter exatamente 5 dígitos numéricos"
            );
        }
    }

    private void validateDescriptionLength(ActivityDescription description) {
        String value = description.getValue();
        if (value.length() < 10 || value.length() > 500) {
            throw new BusinessRuleException(
                "Descrição deve ter entre 10 e 500 caracteres"
            );
        }
    }
}

// Domain Service para validações complexas
@Service
public class CategoryCAEDomainService {
    
    public void validateUniqueCAECodeInCategory(CategoryId categoryId, CAECode caeCode,
                                              CategoryCAEAssociationRepository repository) {
        boolean exists = repository.existsByCategoryIdAndCAECodeAndActiveTrue(categoryId, caeCode);
        if (exists) {
            throw new BusinessRuleException(
                String.format("Código CAE %s já está associado à categoria %s", 
                            caeCode.getValue(), categoryId.getValue())
            );
        }
    }

    public void validateAssociationLimit(CategoryId categoryId, int newAssociationsCount,
                                       CategoryCAEAssociationRepository repository) {
        long currentCount = repository.countByCategoryIdAndActiveTrue(categoryId);
        int maxAssociations = 1000; // Limite configurável
        
        if (currentCount + newAssociationsCount > maxAssociations) {
            throw new BusinessRuleException(
                String.format("Limite de %d associações por categoria excedido", maxAssociations)
            );
        }
    }
}
```

### 6.2 Regras de Negócio

1. **Unicidade**: Código CAE deve ser único por categoria (apenas associações ativas)
2. **Formato CAE**: Código deve conter exatamente 5 dígitos numéricos
3. **Descrição**: Deve ter entre 10 e 500 caracteres
4. **Soft Delete**: Associações eliminadas ficam marcadas como inativas
5. **Auditoria**: Todas as operações devem ser auditadas
6. **Cache**: Invalidação automática em alterações
7. **Limite**: Máximo de 1000 associações por categoria

## 7. Cache e Performance

### 7.1 Estratégia de Cache

```java
@Service
@CacheConfig(cacheNames = "category-cae-associations")
public class CategoryCAECacheService {

    @Cacheable(key = "#categoryId + '_' + #active")
    public List<CategoryCAEAssociationResponse> getAssociationsByCategory(
            UUID categoryId, boolean active) {
        return categoryCAERepository.findByCategoryIdAndActive(categoryId, active);
    }

    @Cacheable(key = "'multiple_' + #categoryIds.hashCode() + '_' + #active")
    public Map<UUID, List<CategoryCAEAssociationResponse>> getAssociationsByCategories(
            List<UUID> categoryIds, boolean active) {
        return categoryCAERepository.findByCategoryIdsAndActive(categoryIds, active);
    }

    @CacheEvict(key = "#categoryId + '_true'")
    public void evictCacheForCategory(UUID categoryId) {
        // Cache invalidation for specific category
    }

    @CacheEvict(allEntries = true)
    public void evictAllCache() {
        // Clear all cache
    }

    // Cache warming strategy
    @EventListener
    @Async
    public void warmCacheOnStartup(ApplicationReadyEvent event) {
        // Pre-load frequently accessed categories
        List<UUID> frequentCategories = getFrequentlyAccessedCategories();
        frequentCategories.forEach(categoryId -> 
            getAssociationsByCategory(categoryId, true));
    }
}
```

### 7.2 Configuração de Cache

```yaml
# application.yml
spring:
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=5000,expireAfterWrite=2h,recordStats
    cache-names:
      - category-cae-associations

management:
  endpoints:
    web:
      exposure:
        include: caches
  endpoint:
    caches:
      enabled: true
```

## 8. Segurança

### 8.1 Controlo de Acesso

* **Consulta (GET)**: Acesso público para endpoints básicos

* **Gestão (POST/PUT/DELETE)**: Requer autenticação JWT + role ADMIN

* **Endpoints Administrativos**: Requer role SUPER\_ADMIN

* **Auditoria**: Todas as operações administrativas são auditadas

### 8.2 Configuração de Segurança

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
public class CategoryCAESecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(authz -> authz
            .requestMatchers(HttpMethod.GET, "/api/v1/categories/*/cae").permitAll()
            .requestMatchers(HttpMethod.GET, "/api/v1/categories/cae").permitAll()
            .requestMatchers("/api/v1/categories/*/cae/**").hasRole("ADMIN")
            .requestMatchers("/api/v1/categories/cae/admin/**").hasRole("SUPER_ADMIN")
            .anyRequest().authenticated()
        )
        .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()))
        .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));
        
        return http.build();
    }

    @Bean
    public JwtAuthenticationConverter jwtAuthenticationConverter() {
        JwtGrantedAuthoritiesConverter authoritiesConverter = new JwtGrantedAuthoritiesConverter();
        authoritiesConverter.setAuthorityPrefix("ROLE_");
        authoritiesConverter.setAuthoritiesClaimName("roles");

        JwtAuthenticationConverter authenticationConverter = new JwtAuthenticationConverter();
        authenticationConverter.setJwtGrantedAuthoritiesConverter(authoritiesConverter);
        return authenticationConverter;
    }
}

// Method-level security
@RestController
public class CategoryCAEController {

    @PreAuthorize("hasRole('ADMIN') and @categorySecurityService.canAccessCategory(#categoryId)")
    @PostMapping("/api/v1/categories/{categoryId}/cae")
    public ResponseEntity<CategoryCAEListResponse> createAssociations(
            @PathVariable UUID categoryId,
            @Valid @RequestBody CreateCAEAssociationRequest request) {
        // Implementation
    }
}
```

## 9. Testes

### 9.1 Testes Unitários

```java
@ExtendWith(MockitoExtension.class)
class CreateCAEAssociationsUseCaseTest {

    @Mock
    private CategoryCAERepositoryPort repository;

    @Mock
    private CategoryCAECachePort cache;

    @Mock
    private CategoryCAEDomainService domainService;

    @InjectMocks
    private CreateCAEAssociationsUseCase useCase;

    @Test
    void shouldCreateAssociationsWhenValidData() {
        // Given
        UUID categoryId = UUID.randomUUID();
        List<CreateCAEAssociationItem> items = createValidAssociationItems();
        
        when(repository.existsCategory(categoryId)).thenReturn(true);
        when(repository.save(any(CategoryCAEAssociation.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

        // When
        CategoryCAEListResponse result = useCase.execute(categoryId, items);

        // Then
        assertThat(result.getCategoryId()).isEqualTo(categoryId);
        assertThat(result.getContent()).hasSize(items.size());
        verify(cache).evictCacheForCategory(categoryId);
        verify(domainService, times(items.size()))
            .validateUniqueCAECodeInCategory(any(), any(), eq(repository));
    }

    @Test
    void shouldThrowExceptionWhenCategoryNotExists() {
        // Given
        UUID categoryId = UUID.randomUUID();
        List<CreateCAEAssociationItem> items = createValidAssociationItems();
        
        when(repository.existsCategory(categoryId)).thenReturn(false);

        // When & Then
        assertThatThrownBy(() -> useCase.execute(categoryId, items))
            .isInstanceOf(CategoryNotFoundException.class)
            .hasMessage("Categoria não encontrada: " + categoryId);
    }

    @Test
    void shouldThrowExceptionWhenDuplicateCAECode() {
        // Given
        UUID categoryId = UUID.randomUUID();
        List<CreateCAEAssociationItem> items = createDuplicateCAEItems();
        
        when(repository.existsCategory(categoryId)).thenReturn(true);
        doThrow(new BusinessRuleException("Código CAE duplicado"))
            .when(domainService).validateUniqueCAECodeInCategory(any(), any(), any());

        // When & Then
        assertThatThrownBy(() -> useCase.execute(categoryId, items))
            .isInstanceOf(BusinessRuleException.class)
            .hasMessage("Código CAE duplicado");
    }
}
```

### 9.2 Testes de Integração

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
@Transactional
class CategoryCAEControllerIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16")
            .withDatabaseName("licensing_test")
            .withUsername("test")
            .withPassword("test");

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private CategoryCAEJpaRepository repository;

    @Test
    void shouldReturnAssociationsWhenValidCategoryId() {
        // Given
        UUID categoryId = createTestCategory();
        createTestAssociations(categoryId, 3);

        // When
        ResponseEntity<CategoryCAEListResponse> response = restTemplate.getForEntity(
            "/api/v1/categories/" + categoryId + "/cae", 
            CategoryCAEListResponse.class);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getCategoryId()).isEqualTo(categoryId);
        assertThat(response.getBody().getContent()).hasSize(3);
        assertThat(response.getBody().getTotalElements()).isEqualTo(3);
    }

    @Test
    @WithMockUser(roles = "ADMIN")
    void shouldCreateAssociationsWhenValidRequest() {
        // Given
        UUID categoryId = createTestCategory();
        CreateCAEAssociationRequest request = CreateCAEAssociationRequest.builder()
            .associations(List.of(
                CreateCAEAssociationItem.builder()
                    .caeCode("12345")
                    .description("Atividade de teste")
                    .active(true)
                    .build()
            ))
            .build();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<CreateCAEAssociationRequest> entity = new HttpEntity<>(request, headers);

        // When
        ResponseEntity<CategoryCAEListResponse> response = restTemplate.postForEntity(
            "/api/v1/categories/" + categoryId + "/cae",
            entity,
            CategoryCAEListResponse.class);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(response.getBody().getContent()).hasSize(1);
        
        // Verify in database
        List<CategoryCAEJpaEntity> saved = repository.findByCategoryIdAndActiveTrue(categoryId);
        assertThat(saved).hasSize(1);
        assertThat(saved.get(0).getCaeCode()).isEqualTo("12345");
    }
}
```

### 9.3 Testes de Performance

```java
@SpringBootTest
@Testcontainers
class CategoryCAEPerformanceTest {

    @Test
    void shouldHandleLargeNumberOfAssociations() {
        // Given
        UUID categoryId = createTestCategory();
        int associationCount = 1000;
        List<CreateCAEAssociationItem> items = createLargeAssociationList(associationCount);

        // When
        long startTime = System.currentTimeMillis();
        CategoryCAEListResponse result = categoryCAEService.createAssociations(categoryId, items);
        long endTime = System.currentTimeMillis();

        // Then
        assertThat(result.getContent()).hasSize(associationCount);
        assertThat(endTime - startTime).isLessThan(5000); // Less than 5 seconds
    }

    @Test
    void shouldMaintainPerformanceWithCaching() {
        // Given
        UUID categoryId = createTestCategory();
        createTestAssociations(categoryId, 100);

        // First call (cache miss)
        long startTime1 = System.currentTimeMillis();
        categoryCAEService.getAssociationsByCategory(categoryId, true);
        long endTime1 = System.currentTimeMillis();

        // Second call (cache hit)
        long startTime2 = System.currentTimeMillis();
        categoryCAEService.getAssociationsByCategory(categoryId, true);
        long endTime2 = System.currentTimeMillis();

        // Then
        long firstCallTime = endTime1 - startTime1;
        long secondCallTime = endTime2 - startTime2;
        assertThat(secondCallTime).isLessThan(firstCallTime / 2); // Cache should be significantly faster
    }
}
```

## 10. Migração e Dados Iniciais

### 10.1 Script de Migração Flyway

```sql
-- V001__create_category_classification_table.sql
CREATE TABLE T_CATEGORY_CLASSIFICATION (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category_id_fk UUID NOT NULL,
    cae_code VARCHAR(10) NOT NULL,
    description TEXT NOT NULL,
    active BOOLEAN DEFAULT TRUE,
    metadata JSONB,
    created_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_modified_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by VARCHAR(100),
    last_modified_by VARCHAR(100)
);

-- Add foreign key constraint (assuming T_LICENSE_CATEGORY exists)
ALTER TABLE T_CATEGORY_CLASSIFICATION 
ADD CONSTRAINT fk_category_classification_category 
FOREIGN KEY (category_id_fk) REFERENCES T_LICENSE_CATEGORY(id);

-- Add check constraints
ALTER TABLE T_CATEGORY_CLASSIFICATION 
ADD CONSTRAINT chk_cae_code_format 
CHECK (cae_code ~ '^[0-9]{5}$');

ALTER TABLE T_CATEGORY_CLASSIFICATION 
ADD CONSTRAINT chk_description_length 
CHECK (LENGTH(description) >= 10 AND LENGTH(description) <= 500);

-- Create indexes
CREATE UNIQUE INDEX idx_category_classification_unique 
ON T_CATEGORY_CLASSIFICATION(category_id_fk, cae_code) 
WHERE active = true;

CREATE INDEX idx_category_classification_category_id 
ON T_CATEGORY_CLASSIFICATION(category_id_fk);

CREATE INDEX idx_category_classification_cae_code 
ON T_CATEGORY_CLASSIFICATION(cae_code);

CREATE INDEX idx_category_classification_active 
ON T_CATEGORY_CLASSIFICATION(active);

CREATE INDEX idx_category_classification_category_active 
ON T_CATEGORY_CLASSIFICATION(category_id_fk, active);

-- Create audit trigger
CREATE OR REPLACE FUNCTION update_last_modified_date()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_modified_date = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_category_classification_update_timestamp
    BEFORE UPDATE ON T_CATEGORY_CLASSIFICATION
    FOR EACH ROW
    EXECUTE FUNCTION update_last_modified_date();
```

### 10.2 Dados Iniciais

```sql
-- V002__insert_initial_category_classifications.sql

-- Assumindo que as categorias já existem, inserir associações iniciais

-- Categoria: Restauração e Bebidas (exemplo)
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active, created_by) VALUES
-- Restaurantes
('11111111-1111-1111-1111-111111111111', '56101', 'Restaurantes com serviço de mesa', true, 'SYSTEM'),
('11111111-1111-1111-1111-111111111111', '56102', 'Restaurantes sem serviço de mesa', true, 'SYSTEM'),
('11111111-1111-1111-1111-111111111111', '56103', 'Restaurantes com esplanada', true, 'SYSTEM'),
('11111111-1111-1111-1111-111111111111', '56104', 'Restaurantes de comida rápida', true, 'SYSTEM'),
-- Bares e Cafés
('11111111-1111-1111-1111-111111111111', '56301', 'Cafés', true, 'SYSTEM'),
('11111111-1111-1111-1111-111111111111', '56302', 'Bares', true, 'SYSTEM'),
('11111111-1111-1111-1111-111111111111', '56303', 'Pastelarias e casas de chá', true, 'SYSTEM');

-- Categoria: Comércio a Retalho (exemplo)
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active, metadata, created_by) VALUES
-- Supermercados e Hipermercados
('22222222-2222-2222-2222-222222222222', '47111', 'Comércio a retalho em supermercados', true, '{"min_area": 400, "type": "supermarket"}', 'SYSTEM'),
('22222222-2222-2222-2222-222222222222', '47112', 'Comércio a retalho em hipermercados', true, '{"min_area": 2500, "type": "hypermarket"}', 'SYSTEM'),
-- Comércio Especializado
('22222222-2222-2222-2222-222222222222', '47211', 'Comércio a retalho de frutas e produtos hortícolas', true, '{"category": "food", "perishable": true}', 'SYSTEM'),
('22222222-2222-2222-2222-222222222222', '47221', 'Comércio a retalho de carnes e produtos à base de carne', true, '{"category": "food", "requires_cold_chain": true}', 'SYSTEM'),
('22222222-2222-2222-2222-222222222222', '47230', 'Comércio a retalho de peixe, crustáceos e moluscos', true, '{"category": "food", "requires_cold_chain": true}', 'SYSTEM');

-- Categoria: Alojamento Turístico (exemplo)
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active, metadata, created_by) VALUES
-- Hotéis
('33333333-3333-3333-3333-333333333333', '55111', 'Hotéis com restaurante', true, '{"stars_min": 1, "stars_max": 5, "has_restaurant": true}', 'SYSTEM'),
('33333333-3333-3333-3333-333333333333', '55112', 'Hotéis sem restaurante', true, '{"stars_min": 1, "stars_max": 5, "has_restaurant": false}', 'SYSTEM'),
-- Alojamento Rural
('33333333-3333-3333-3333-333333333333', '55201', 'Alojamento turístico em espaço rural', true, '{"type": "rural", "max_capacity": 50}', 'SYSTEM'),
('33333333-3333-3333-3333-333333333333', '55202', 'Turismo de habitação', true, '{"type": "heritage", "historical": true}', 'SYSTEM'),
-- Outros Alojamentos
('33333333-3333-3333-3333-333333333333', '55301', 'Parques de campismo e de caravanismo', true, '{"type": "camping", "outdoor": true}', 'SYSTEM'),
('33333333-3333-3333-3333-333333333333', '55900', 'Outros locais de alojamento de curta duração', true, '{"type": "other", "short_term": true}', 'SYSTEM');

-- Categoria: Transportes (exemplo)
INSERT INTO T_CATEGORY_CLASSIFICATION (category_id_fk, cae_code, description, active, created_by) VALUES
-- Transporte Terrestre
('44444444-4444-4444-4444-444444444444', '49311', 'Transportes urbanos e suburbanos de passageiros', true, 'SYSTEM'),
('44444444-4444-4444-4444-444444444444', '49312', 'Transportes de passageiros por táxi', true, 'SYSTEM'),
('44444444-4444-4444-4444-444444444444', '49320', 'Transportes de passageiros por veículos ligeiros ou pesados de passageiros', true, 'SYSTEM'),
-- Transporte de Mercadorias
('44444444-4444-4444-4444-444444444444', '49411', 'Transportes rodoviários de mercadorias', true, 'SYSTEM'),
('44444444-4444-4444-4444-444444444444', '49412', 'Mudanças', true, 'SYSTEM');
```

## 11. Monitorização e Métricas

### 11.1 Métricas de Performance

```java
@Component
public class CategoryCAEMetrics {

    private final Counter associationRequestsCounter;
    private final Timer associationRequestsTimer;
    private final Gauge cacheHitRatio;
    private final Counter validationErrorsCounter;

    public CategoryCAEMetrics(MeterRegistry meterRegistry) {
        this.associationRequestsCounter = Counter.builder("category_cae.requests.total")
            .description("Total number of category CAE association requests")
            .tag("module", "category-cae")
            .register(meterRegistry);

        this.associationRequestsTimer = Timer.builder("category_cae.requests.duration")
            .description("Duration of category CAE association requests")
            .tag("module", "category-cae")
            .register(meterRegistry);

        this.cacheHitRatio = Gauge.builder("category_cae.cache.hit_ratio")
            .description("Cache hit ratio for category CAE associations")
            .register(meterRegistry, this, CategoryCAEMetrics::calculateCacheHitRatio);

        this.validationErrorsCounter = Counter.builder("category_cae.validation.errors.total")
            .description("Total number of validation errors")
            .tag("module", "category-cae")
            .register(meterRegistry);
    }

    public void incrementRequestCounter(String operation, String status) {
        associationRequestsCounter.increment(
            Tags.of("operation", operation, "status", status)
        );
    }

    public Timer.Sample startTimer() {
        return Timer.start(associationRequestsTimer);
    }

    public void incrementValidationErrors(String validationType) {
        validationErrorsCounter.increment(Tags.of("type", validationType));
    }

    private double calculateCacheHitRatio() {
        // Implementation to calculate cache hit ratio
        return 0.85; // Example value
    }
}

// Usage in service layer
@Service
public class CategoryCAEApplicationService {

    private final CategoryCAEMetrics metrics;

    public CategoryCAEListResponse getAssociationsByCategory(UUID categoryId, Pageable pageable) {
        Timer.Sample sample = metrics.startTimer();
        try {
            CategoryCAEListResponse result = // ... implementation
            metrics.incrementRequestCounter("get_by_category", "success");
            return result;
        } catch (Exception e) {
            metrics.incrementRequestCounter("get_by_category", "error");
            throw e;
        } finally {
            sample.stop();
        }
    }
}
```

### 11.2 Health Checks

```java
@Component
public class CategoryCAEHealthIndicator implements HealthIndicator {

    private final CategoryCAEJpaRepository repository;
    private final CacheManager cacheManager;

    public CategoryCAEHealthIndicator(CategoryCAEJpaRepository repository, 
                                    CacheManager cacheManager) {
        this.repository = repository;
        this.cacheManager = cacheManager;
    }

    @Override
    public Health health() {
        try {
            // Check database connectivity
            long totalAssociations = repository.count();
            
            // Check cache availability
            Cache cache = cacheManager.getCache("category-cae-associations");
            boolean cacheAvailable = cache != null;
            
            // Check for any critical issues
            long activeAssociations = repository.countByActiveTrue();
            double activeRatio = (double) activeAssociations / totalAssociations;
            
            Health.Builder builder = Health.up()
                .withDetail("total_associations", totalAssociations)
                .withDetail("active_associations", activeAssociations)
                .withDetail("active_ratio", String.format("%.2f%%", activeRatio * 100))
                .withDetail("cache_available", cacheAvailable);
            
            if (activeRatio < 0.5) {
                builder.status("DEGRADED")
                    .withDetail("warning", "Low ratio of active associations");
            }
            
            return builder.build();
            
        } catch (Exception e) {
            return Health.down()
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}
```

### 11.3 Configuração de Monitorização

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,caches
  endpoint:
    health:
      show-details: always
      show-components: always
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: licensing-system
      module: category-cae
    distribution:
      percentiles:
        category_cae.requests.duration: 0.5,0.95,0.99
      percentiles-histogram:
        category_cae.requests.duration: true

logging:
  level:
    cv.gov.licensing.categoryassociation: DEBUG
    org.springframework.cache: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/category-cae.log
    max-size: 10MB
    max-history: 30
```

## 12. Deployment e Configuração

### 12.1 Configuração de Ambiente

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:licensing}
    username: ${DB_USERNAME:licensing_user}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false
        jdbc:
          batch_size: 25
        order_inserts: true
        order_updates: true

  cache:
    type: redis
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 1
      timeout: 2000ms

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI}
          jwk-set-uri: ${JWT_JWK_SET_URI}

# Custom application properties
app:
  category-cae:
    max-associations-per-category: ${MAX_ASSOCIATIONS:1000}
    cache:
      ttl: ${CACHE_TTL:7200} # 2 hours
      max-size: ${CACHE_MAX_SIZE:10000}
    validation:
      cae-code-pattern: "^[0-9]{5}$"
      description-min-length: 10
      description-max-length: 500
```

### 12.2 Docker Configuration

```dockerfile
# Dockerfile
FROM openjdk:21-jre-slim

LABEL maintainer="Licensing System Team"
LABEL version="1.0.0"
LABEL description="Category CAE Association Service"

# Create application user
RUN groupadd -r licensing && useradd -r -g licensing licensing

# Set working directory
WORKDIR /app

# Copy application jar
COPY target/category-cae-service-*.jar app.jar

# Create logs directory
RUN mkdir -p /app/logs && chown -R licensing:licensing /app

# Switch to application user
USER licensing

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# Expose port
EXPOSE 8080

# JVM options for production
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseStringDeduplication"

# Run application
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  category-cae-service:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=postgres
      - DB_NAME=licensing
      - DB_USERNAME=licensing_user
      - DB_PASSWORD=licensing_pass
      - REDIS_HOST=redis
      - JWT_ISSUER_URI=https://auth.licensing.gov.cv
    depends_on:
      - postgres
      - redis
    networks:
      - licensing-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_DB=licensing
      - POSTGRES_USER=licensing_user
      - POSTGRES_PASSWORD=licensing_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - licensing-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - licensing-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  licensing-network:
    driver: bridge
```

