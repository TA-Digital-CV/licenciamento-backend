# PR01.05-BE-LIC - Dossier Tipo de Licença - Associação de Taxas

## 1. Visão Geral

Este documento especifica a gestão da associação entre tipos de licença e taxas aplicáveis, definindo a estrutura de custos, regras de cálculo, descontos, isenções e formas de pagamento para cada tipo de licenciamento. Este módulo é essencial para garantir transparência, conformidade regulatória e eficiência na cobrança de taxas do sistema de licenciamento.

**Módulo:** Dossier de Tipo de Licença - Associação de Taxas  
**Endpoint Base:** `/api/v1/process-type-fees` e `/api/v1/fee-categories`  
**Versão:** 1.0  
**Data:** 2025

---

## 2. Estrutura do Módulo de Taxas

### 2.1 Categoria de Taxa (Fee Category)

#### 2.1.1 Campos da Categoria de Taxa
| Campo | Tipo | Validação | Descrição |
|-------|------|-----------|----------|
| id | String | Auto-gerado | Identificador único |
| name | String | 2-200 chars, NotBlank | Nome da categoria |
| code | String | NotBlank, Unique | Código identificador |
| description | String | Max 1000 chars | Descrição detalhada |
| feeType | String | Must exist in OPTIONS | Tipo de taxa (FIXED, PERCENTAGE, VARIABLE) |
| calculationBasis | String | Must exist in OPTIONS | Base de cálculo |
| isRecurring | Boolean | NotNull | Se é taxa recorrente |
| recurringPeriod | String | Required if recurring | Período de recorrência |
| isRefundable | Boolean | NotNull | Se é reembolsável |
| refundConditions | String | JSON válido | Condições para reembolso |
| paymentMethods | Array | Valid list | Métodos de pagamento aceitos |
| currency | String | NotBlank | Moeda (CVE, EUR, USD) |

#### 2.1.2 Estrutura do DTO de Categoria de Taxa
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@IgrpDTO
public class FeeCategoryRequestDTO {
    @NotNull(message = "Nome é obrigatório")
    @NotBlank(message = "Nome não pode estar vazio")
    @Size(min = 2, max = 200, message = "Nome deve ter entre 2 e 200 caracteres")
    private String name;
    
    @NotNull(message = "Código é obrigatório")
    @NotBlank(message = "Código não pode estar vazio")
    @Pattern(regexp = "^[A-Z0-9_]+$", message = "Código deve conter apenas letras maiúsculas, números e underscore")
    private String code;
    
    @Size(max = 1000, message = "Descrição não pode exceder 1000 caracteres")
    private String description;
    
    @NotNull(message = "Tipo de taxa é obrigatório")
    @NotBlank(message = "Tipo de taxa não pode estar vazio")
    private String feeTypeKey;  // Referência para OPTIONS com ccode="FEE_TYPE"
    
    @NotNull(message = "Base de cálculo é obrigatória")
    @NotBlank(message = "Base de cálculo não pode estar vazia")
    private String calculationBasisKey;  // Referência para OPTIONS com ccode="CALCULATION_BASIS"
    
    @NotNull(message = "Campo 'é recorrente' é obrigatório")
    private Boolean isRecurring;
    
    private String recurringPeriodKey;  // Referência para OPTIONS com ccode="RECURRING_PERIOD"
    
    @NotNull(message = "Campo 'é reembolsável' é obrigatório")
    private Boolean isRefundable;
    
    @Valid
    private RefundConditionsDTO refundConditions;
    
    @NotEmpty(message = "Pelo menos um método de pagamento deve ser especificado")
    private List<String> paymentMethodKeys;  // Referência para OPTIONS com ccode="PAYMENT_METHOD"
    
    @NotNull(message = "Moeda é obrigatória")
    @NotBlank(message = "Moeda não pode estar vazia")
    @Pattern(regexp = "^(CVE|EUR|USD)$", message = "Moeda deve ser CVE, EUR ou USD")
    private String currency;
    
    private Object metadata;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class RefundConditionsDTO {
    private Integer refundPeriodDays;
    private BigDecimal refundPercentage;
    private List<String> refundReasons;
    private Boolean requiresApproval;
    private String approvalLevel;
    private Object customConditions;
}
```

### 2.2 Taxa por Tipo de Processo (Process Type Fee)

#### 2.2.1 Campos da Taxa por Tipo de Processo
| Campo | Tipo | Validação | Descrição |
|-------|------|-----------|----------|
| id | String | Auto-gerado | Identificador único |
| processTypeId | String | NotBlank, Must exist | ID do tipo de processo |
| feeCategoryId | String | NotBlank, Must exist | ID da categoria de taxa |
| baseAmount | BigDecimal | Min: 0, Scale: 2 | Valor base da taxa |
| minimumAmount | BigDecimal | Min: 0, Scale: 2 | Valor mínimo |
| maximumAmount | BigDecimal | Min: 0, Scale: 2 | Valor máximo |
| calculationFormula | String | Valid expression | Fórmula de cálculo |
| discountRules | Array | Valid list | Regras de desconto |
| exemptionCriteria | Array | Valid list | Critérios de isenção |
| effectiveDate | LocalDate | NotNull | Data de vigência |
| expirationDate | LocalDate | After effective | Data de expiração |
| isActive | Boolean | NotNull | Se está ativa |

#### 2.2.2 Estrutura do DTO de Taxa por Tipo de Processo
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@IgrpDTO
public class ProcessTypeFeeRequestDTO {
    @NotNull(message = "ID do tipo de processo é obrigatório")
    @NotBlank(message = "ID do tipo de processo não pode estar vazio")
    private String processTypeId;
    
    @NotNull(message = "ID da categoria de taxa é obrigatório")
    @NotBlank(message = "ID da categoria de taxa não pode estar vazio")
    private String feeCategoryId;
    
    @NotNull(message = "Valor base é obrigatório")
    @DecimalMin(value = "0.0", message = "Valor base deve ser maior ou igual a zero")
    @Digits(integer = 10, fraction = 2, message = "Valor base deve ter no máximo 10 dígitos inteiros e 2 decimais")
    private BigDecimal baseAmount;
    
    @DecimalMin(value = "0.0", message = "Valor mínimo deve ser maior ou igual a zero")
    @Digits(integer = 10, fraction = 2, message = "Valor mínimo deve ter no máximo 10 dígitos inteiros e 2 decimais")
    private BigDecimal minimumAmount;
    
    @DecimalMin(value = "0.0", message = "Valor máximo deve ser maior ou igual a zero")
    @Digits(integer = 10, fraction = 2, message = "Valor máximo deve ter no máximo 10 dígitos inteiros e 2 decimais")
    private BigDecimal maximumAmount;
    
    @Size(max = 500, message = "Fórmula de cálculo não pode exceder 500 caracteres")
    private String calculationFormula;
    
    @Valid
    private List<DiscountRuleDTO> discountRules;
    
    @Valid
    private List<ExemptionCriteriaDTO> exemptionCriteria;
    
    @NotNull(message = "Data de vigência é obrigatória")
    @FutureOrPresent(message = "Data de vigência deve ser presente ou futura")
    private LocalDate effectiveDate;
    
    @Future(message = "Data de expiração deve ser futura")
    private LocalDate expirationDate;
    
    private Object metadata;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class DiscountRuleDTO {
    @NotNull(message = "Nome da regra é obrigatório")
    @NotBlank(message = "Nome da regra não pode estar vazio")
    private String ruleName;
    
    @NotNull(message = "Tipo de desconto é obrigatório")
    private String discountType;  // PERCENTAGE, FIXED_AMOUNT, FORMULA
    
    @NotNull(message = "Valor do desconto é obrigatório")
    @DecimalMin(value = "0.0", message = "Valor do desconto deve ser maior ou igual a zero")
    private BigDecimal discountValue;
    
    @Valid
    private DiscountConditionsDTO conditions;
    
    private Integer priority;
    private Boolean stackable;
    private LocalDate validFrom;
    private LocalDate validUntil;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class DiscountConditionsDTO {
    private String applicantType;  // INDIVIDUAL, COMPANY, NGO
    private BigDecimal minimumInvestment;
    private BigDecimal maximumInvestment;
    private Integer minimumEmployees;
    private String locationZone;
    private Boolean isFirstTime;
    private Boolean isRenewal;
    private List<String> requiredCertifications;
    private Object customConditions;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ExemptionCriteriaDTO {
    @NotNull(message = "Nome do critério é obrigatório")
    @NotBlank(message = "Nome do critério não pode estar vazio")
    private String criteriaName;
    
    @NotNull(message = "Tipo de isenção é obrigatório")
    private String exemptionType;  // TOTAL, PARTIAL, CONDITIONAL
    
    @DecimalMin(value = "0.0", message = "Percentual de isenção deve ser maior ou igual a zero")
    @DecimalMax(value = "100.0", message = "Percentual de isenção deve ser menor ou igual a 100")
    private BigDecimal exemptionPercentage;
    
    @Valid
    private ExemptionConditionsDTO conditions;
    
    private Boolean requiresApproval;
    private String approvalLevel;
    private LocalDate validFrom;
    private LocalDate validUntil;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ExemptionConditionsDTO {
    private String applicantCategory;  // STARTUP, NGO, GOVERNMENT, DISABLED
    private String businessSector;
    private String socialImpactLevel;
    private Boolean isPublicInterest;
    private Boolean hasDisabilitySupport;
    private List<String> requiredDocuments;
    private Object customConditions;
}
```

---

## 3. API REST - Gestão de Categorias de Taxa

### 3.1 Operações CRUD de Categorias de Taxa

#### 3.1.1 Listagem de Categorias de Taxa
**Endpoint:** `GET /api/v1/fee-categories`

**Parâmetros de Query:**
| Parâmetro | Tipo | Obrigatório | Padrão | Descrição |
|-----------|------|-------------|--------|-----------|
| feeType | string | Não | - | Tipo de taxa para filtrar |
| calculationBasis | string | Não | - | Base de cálculo |
| isRecurring | boolean | Não | - | Se é taxa recorrente |
| currency | string | Não | - | Moeda (CVE, EUR, USD) |
| name | string | Não | - | Nome da categoria ou termo de busca |
| code | string | Não | - | Código da categoria |
| pageNumber | string | Não | "0" | Número da página |
| pageSize | string | Não | "20" | Tamanho da página |
| sort | string | Não | "name" | Campo de ordenação |
| direction | string | Não | "ASC" | Direção da ordenação (ASC/DESC) |

**Resposta de Sucesso (200):**
```json
{
  "pageNumber": 0,
  "pageSize": 20,
  "totalElements": 15,
  "totalPages": 1,
  "content": [
    {
      "id": "fc-001",
      "name": "Taxa de Licenciamento Inicial",
      "code": "LIC_INICIAL",
      "description": "Taxa cobrada para o licenciamento inicial de estabelecimentos comerciais",
      "feeType": {
        "key": "FIXED",
        "name": "Taxa Fixa"
      },
      "calculationBasis": {
        "key": "FLAT_RATE",
        "name": "Taxa Única"
      },
      "isRecurring": false,
      "isRefundable": true,
      "currency": "CVE",
      "paymentMethods": [
        {
          "key": "BANK_TRANSFER",
          "name": "Transferência Bancária"
        },
        {
          "key": "CASH",
          "name": "Dinheiro"
        }
      ],
      "active": true,
      "createdAt": "2025-01-15T10:30:00Z",
      "updatedAt": "2025-01-15T10:30:00Z"
    }
  ]
}
```

#### 3.1.2 Busca de Categoria de Taxa por ID
**Endpoint:** `GET /api/v1/fee-categories/{feeCategoryId}`

**Parâmetros de Path:**
| Parâmetro | Tipo | Descrição |
|-----------|------|-----------|
| feeCategoryId | string | ID único da categoria de taxa |

**Resposta de Sucesso (200):**
```json
{
  "id": "fc-001",
  "name": "Taxa de Licenciamento Inicial",
  "code": "LIC_INICIAL",
  "description": "Taxa cobrada para o licenciamento inicial de estabelecimentos comerciais",
  "feeType": {
    "key": "FIXED",
    "name": "Taxa Fixa",
    "description": "Valor fixo independente de variáveis"
  },
  "calculationBasis": {
    "key": "FLAT_RATE",
    "name": "Taxa Única",
    "description": "Valor único aplicado"
  },
  "isRecurring": false,
  "recurringPeriod": null,
  "isRefundable": true,
  "refundConditions": {
    "refundPeriodDays": 30,
    "refundPercentage": 100.00,
    "refundReasons": ["PROCESS_CANCELLED", "DUPLICATE_PAYMENT"],
    "requiresApproval": true,
    "approvalLevel": "MANAGER"
  },
  "paymentMethods": [
    {
      "key": "BANK_TRANSFER",
      "name": "Transferência Bancária"
    },
    {
      "key": "CASH",
      "name": "Dinheiro"
    }
  ],
  "currency": "CVE",
  "active": true,
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z",
  "metadata": {
    "department": "Licenciamento",
    "approvalRequired": false
  }
}
```

**Códigos de Status:**
- 200: Categoria de taxa encontrada
- 404: Categoria de taxa não encontrada
- 500: Erro interno do servidor

#### 3.1.4 Atualização de Categoria de Taxa
**Endpoint:** `PUT /api/v1/fee-categories/{feeCategoryId}`

**Parâmetros de Path:**
| Parâmetro | Tipo | Descrição |
|-----------|------|-----------|
| feeCategoryId | string | ID único da categoria de taxa |

**Payload de Requisição:** (mesmo formato da criação)

**Códigos de Status:**
- 200: Categoria de taxa atualizada com sucesso
- 400: Dados inválidos
- 404: Categoria de taxa não encontrada
- 409: Código já existe
- 500: Erro interno do servidor

#### 3.1.5 Detalhes de Categoria de Taxa
**Endpoint:** `GET /api/v1/fee-categories/{feeCategoryId}`

**Resposta de Sucesso (200):**
```json
{
  "id": "fc-001",
  "name": "Taxa de Licenciamento Inicial",
  "code": "LIC_INICIAL",
  "description": "Taxa aplicada para obtenção de nova licença de funcionamento, calculada com base no tipo de estabelecimento e complexidade do processo",
  "feeType": {
    "key": "FIXED",
    "name": "Taxa Fixa",
    "description": "Valor fixo independente de variáveis externas"
  },
  "calculationBasis": {
    "key": "FLAT_RATE",
    "name": "Taxa Única",
    "description": "Valor único por solicitação, independente de características específicas"
  },
  "recurringDetails": {
    "isRecurring": false,
    "recurringPeriod": null,
    "nextDueCalculation": null
  },
  "refundPolicy": {
    "isRefundable": true,
    "refundConditions": {
      "refundPeriodDays": 30,
      "refundPercentage": 80.0,
      "refundReasons": [
        "CANCELAMENTO_VOLUNTARIO",
        "INDEFERIMENTO",
        "ERRO_ADMINISTRATIVO"
      ],
      "requiresApproval": true,
      "approvalLevel": "SUPERVISOR",
      "customConditions": {
        "excludeProcessingCosts": true,
        "proRataCalculation": false
      }
    },
    "refundStatistics": {
      "totalRefunds": 45,
      "totalRefundAmount": 540000.00,
      "averageRefundTime": 7.5,
      "refundRate": 3.2
    }
  },
  "paymentOptions": {
    "acceptedMethods": [
      {
        "key": "BANK_TRANSFER",
        "name": "Transferência Bancária",
        "processingTime": "1-2 dias úteis",
        "additionalFee": 0.00
      },
      {
        "key": "CREDIT_CARD",
        "name": "Cartão de Crédito",
        "processingTime": "Imediato",
        "additionalFee": 150.00
      },
      {
        "key": "CASH",
        "name": "Dinheiro",
        "processingTime": "Imediato",
        "additionalFee": 0.00,
        "restrictions": "Apenas até 50.000 CVE"
      }
    ],
    "installmentOptions": {
      "available": true,
      "maxInstallments": 3,
      "minimumAmount": 30000.00,
      "interestRate": 0.0
    }
  },
  "currency": "CVE",
  "associatedProcessTypes": [
    {
      "processTypeId": "pt-001",
      "processTypeName": "Análise Técnica Inicial",
      "baseAmount": 15000.00,
      "averageAmount": 15000.00,
      "applicationsCount": 450
    },
    {
      "processTypeId": "pt-002",
      "processTypeName": "Inspeção de Segurança",
      "baseAmount": 12000.00,
      "averageAmount": 11500.00,
      "applicationsCount": 380
    }
  ],
  "financialSummary": {
    "totalRevenue": 2450000.00,
    "averageFeeAmount": 15000.00,
    "totalApplications": 1630,
    "collectionRate": 96.8,
    "outstandingAmount": 78400.00
  },
  "regulatoryInfo": {
    "legalBasis": "Decreto-Lei nº 45/2019, Artigo 15º",
    "lastReview": "2025-01-15",
    "nextReview": "2025-01-15",
    "approvalAuthority": "Ministério das Finanças",
    "publicationDate": "2019-08-20"
  },
  "metadata": {
    "category": "LICENSING",
    "priority": "HIGH",
    "automationLevel": "FULL",
    "qualityMetrics": {
      "accuracyRate": 99.2,
      "disputeRate": 0.8,
      "customerSatisfaction": 4.3
    }
  }
}
```

#### 3.1.3 Criação de Categoria de Taxa
**Endpoint:** `POST /api/v1/fee-categories`

**Payload de Requisição:**
```json
{
  "name": "Taxa de Renovação Anual",
  "code": "LIC_RENOVACAO_ANUAL",
  "description": "Taxa aplicada para renovação anual de licenças de funcionamento, com desconto para renovações antecipadas",
  "feeTypeKey": "PERCENTAGE",
  "calculationBasisKey": "BUSINESS_REVENUE",
  "isRecurring": true,
  "recurringPeriodKey": "ANNUAL",
  "isRefundable": false,
  "refundConditions": null,
  "paymentMethodKeys": [
    "BANK_TRANSFER",
    "CREDIT_CARD",
    "DIRECT_DEBIT"
  ],
  "currency": "CVE",
  "metadata": {
    "regulatoryReference": "Decreto-Lei nº 45/2019, Artigo 18º",
    "category": "RENEWAL",
    "priority": "MEDIUM",
    "automationLevel": "PARTIAL",
    "earlyRenewalDiscount": {
      "enabled": true,
      "discountPercentage": 10.0,
      "earlyDays": 30
    }
  }
}
```

---

## 4. API REST - Gestão de Taxas por Tipo de Processo

### 4.1 Operações CRUD de Taxas por Tipo de Processo

#### 4.1.1 Listagem de Taxas por Tipo de Processo
**Endpoint:** `GET /api/v1/process-type-fees`

**Parâmetros de Query:**
| Parâmetro | Tipo | Obrigatório | Padrão | Descrição |
|-----------|------|-------------|--------|-----------|
| processTypeId | string | Não | - | ID do tipo de processo para filtrar |
| feeCategoryId | string | Não | - | ID da categoria de taxa |
| isActive | boolean | Não | true | Se está ativa |
| effectiveDate | date | Não | - | Data de vigência |
| currency | string | Não | - | Moeda (CVE, EUR, USD) |
| minAmount | decimal | Não | - | Valor mínimo para filtrar |
| maxAmount | decimal | Não | - | Valor máximo para filtrar |
| pageNumber | string | Não | "0" | Número da página |
| pageSize | string | Não | "20" | Tamanho da página |
| sort | string | Não | "baseAmount" | Campo de ordenação |
| direction | string | Não | "ASC" | Direção da ordenação (ASC/DESC) |

**Resposta de Sucesso (200):**
```json
{
  "pageNumber": 0,
  "pageSize": 20,
  "totalElements": 45,
  "totalPages": 3,
  "content": [
    {
      "id": "ptf-001",
      "processType": {
        "id": "pt-001",
        "name": "Análise Técnica Inicial",
        "code": "PROC_ANALISE_INICIAL",
        "category": "INITIAL_LICENSING"
      },
      "feeCategory": {
        "id": "fc-001",
        "name": "Taxa de Licenciamento Inicial",
        "code": "LIC_INICIAL",
        "feeType": "FIXED"
      },
      "feeStructure": {
        "baseAmount": 15000.00,
        "minimumAmount": 10000.00,
        "maximumAmount": 25000.00,
        "calculationFormula": "BASE_AMOUNT",
        "currency": "CVE"
      },
      "discountRules": [
        {
          "ruleName": "Desconto Primeira Licença",
          "discountType": "PERCENTAGE",
          "discountValue": 20.0,
          "conditions": {
            "isFirstTime": true
          },
          "priority": 1,
          "stackable": true
        }
      ],
      "exemptionCriteria": [
        {
          "criteriaName": "Isenção ONGs",
          "exemptionType": "TOTAL",
          "exemptionPercentage": 100.0,
          "conditions": {
            "applicantCategory": "NGO",
            "isPublicInterest": true
          },
          "requiresApproval": true,
          "approvalLevel": "DIRECTOR"
        }
      ],
      "validity": {
        "effectiveDate": "2025-01-01",
        "expirationDate": "2025-12-31",
        "isActive": true
      },
      "statistics": {
        "totalApplications": 450,
        "totalRevenue": 6075000.00,
        "averageAmount": 13500.00,
        "discountApplications": 90,
        "exemptionApplications": 15
      }
    }
  ]
}
```

#### 4.1.2 Busca de Taxa por Tipo de Processo por ID
**Endpoint:** `GET /api/v1/process-type-fees/{processTypeFeeId}`

**Parâmetros de Path:**
| Parâmetro | Tipo | Descrição |
|-----------|------|-----------||
| processTypeFeeId | string | ID único da taxa por tipo de processo |

**Resposta de Sucesso (200):**
```json
{
  "id": "ptf-001",
  "processType": {
    "id": "pt-001",
    "name": "Análise Técnica Inicial",
    "code": "PROC_ANALISE_INICIAL",
    "category": "INITIAL_LICENSING",
    "complexity": "MEDIUM"
  },
  "feeCategory": {
    "id": "fc-001",
    "name": "Taxa de Licenciamento Inicial",
    "code": "LIC_INICIAL",
    "feeType": "FIXED",
    "currency": "CVE"
  },
  "baseAmount": 15000.00,
  "minimumAmount": 10000.00,
  "maximumAmount": 25000.00,
  "calculationFormula": "baseAmount * complexityFactor",
  "discountRules": [
    {
      "ruleName": "Desconto Primeira Licença",
      "discountType": "PERCENTAGE",
      "discountValue": 20.00,
      "conditions": {
        "isFirstTime": true,
        "applicantType": "INDIVIDUAL"
      },
      "priority": 1,
      "stackable": false
    }
  ],
  "exemptionCriteria": [],
  "effectiveDate": "2025-01-01",
  "expirationDate": null,
  "isActive": true,
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z",
  "metadata": {
    "approvalRequired": false,
    "department": "Licenciamento"
  }
}
```

**Códigos de Status:**
- 200: Taxa encontrada
- 404: Taxa não encontrada
- 500: Erro interno do servidor

#### 4.1.3 Criação de Taxa por Tipo de Processo
**Endpoint:** `POST /api/v1/process-type-fees`

**Payload de Requisição:** (formato do ProcessTypeFeeRequestDTO)

**Códigos de Status:**
- 201: Taxa criada com sucesso
- 400: Dados inválidos
- 409: Conflito (taxa já existe para o tipo de processo)
- 500: Erro interno do servidor

#### 4.1.4 Atualização de Taxa por Tipo de Processo
**Endpoint:** `PUT /api/v1/process-type-fees/{processTypeFeeId}`

**Parâmetros de Path:**
| Parâmetro | Tipo | Descrição |
|-----------|------|-----------||
| processTypeFeeId | string | ID único da taxa por tipo de processo |

**Payload de Requisição:** (mesmo formato da criação)

**Códigos de Status:**
- 200: Taxa atualizada com sucesso
- 400: Dados inválidos
- 404: Taxa não encontrada
- 500: Erro interno do servidor

#### 4.1.5 Cálculo de Taxa
**Endpoint:** `POST /api/v1/process-type-fees/{processTypeFeeId}/calculate`

**Payload de Requisição:**
```json
{
  "applicantProfile": {
    "type": "COMPANY",
    "businessSector": "RESTAURANT",
    "annualRevenue": 2500000.00,
    "employees": 15,
    "locationZone": "COMMERCIAL",
    "isFirstTime": true,
    "hasDisabilitySupport": false,
    "certifications": ["ISO_9001", "HACCP"]
  },
  "applicationDetails": {
    "licenseTypeId": "lt-001",
    "processTypeId": "pt-001",
    "requestedDate": "2025-03-15",
    "urgentProcessing": false,
    "additionalServices": ["CONSULTATION", "DOCUMENT_REVIEW"]
  },
  "previousLicenses": [
    {
      "type": "FIRE_SAFETY_LICENSE",
      "issueDate": "2023-08-10",
      "status": "ACTIVE"
    }
  ]
}
```

**Resposta de Sucesso (200):**
```json
{
  "calculationId": "calc-001",
  "processTypeFeeId": "ptf-001",
  "applicantProfile": {
    "type": "COMPANY",
    "qualifiedForDiscounts": true,
    "qualifiedForExemptions": false
  },
  "feeCalculation": {
    "baseAmount": 15000.00,
    "applicableDiscounts": [
      {
        "ruleName": "Desconto Primeira Licença",
        "discountType": "PERCENTAGE",
        "discountValue": 20.0,
        "discountAmount": 3000.00,
        "reason": "Primeira solicitação de licença"
      },
      {
        "ruleName": "Desconto Certificação Qualidade",
        "discountType": "FIXED_AMOUNT",
        "discountValue": 1000.00,
        "discountAmount": 1000.00,
        "reason": "Possui certificação ISO 9001"
      }
    ],
    "totalDiscounts": 4000.00,
    "applicableExemptions": [],
    "totalExemptions": 0.00,
    "subtotal": 11000.00,
    "additionalFees": [
      {
        "name": "Taxa de Processamento",
        "amount": 500.00,
        "reason": "Taxa administrativa obrigatória"
      }
    ],
    "totalAdditionalFees": 500.00,
    "finalAmount": 11500.00,
    "currency": "CVE"
  },
  "paymentOptions": {
    "availableMethods": [
      {
        "method": "BANK_TRANSFER",
        "processingFee": 0.00,
        "totalAmount": 11500.00
      },
      {
        "method": "CREDIT_CARD",
        "processingFee": 150.00,
        "totalAmount": 11650.00
      }
    ],
    "installmentOptions": {
      "available": false,
      "reason": "Valor abaixo do mínimo para parcelamento"
    },
    "dueDate": "2025-04-14",
    "lateFeeRate": 2.0
  },
  "calculationBreakdown": {
    "formula": "BASE_AMOUNT - DISCOUNTS + ADDITIONAL_FEES",
    "steps": [
      {
        "step": 1,
        "description": "Valor base da taxa",
        "amount": 15000.00
      },
      {
        "step": 2,
        "description": "Aplicação de desconto por primeira licença (20%)",
        "amount": -3000.00
      },
      {
        "step": 3,
        "description": "Aplicação de desconto por certificação",
        "amount": -1000.00
      },
      {
        "step": 4,
        "description": "Adição de taxa de processamento",
        "amount": 500.00
      }
    ]
  },
  "validityPeriod": {
    "calculationDate": "2025-03-15T10:30:00Z",
    "validUntil": "2025-03-22T10:30:00Z",
    "reason": "Cálculo válido por 7 dias"
  },
  "recommendations": [
    "Considere solicitar outras licenças em conjunto para obter descontos adicionais",
    "Mantenha as certificações atualizadas para continuar elegível aos descontos",
    "Pagamento antecipado pode gerar desconto adicional de 5%"
  ]
}
```

#### 4.1.3 Simulação de Cenários de Taxa
**Endpoint:** `POST /api/v1/process-type-fees/simulate-scenarios`

**Payload de Requisição:**
```json
{
  "baseScenario": {
    "applicantType": "COMPANY",
    "businessSector": "RESTAURANT",
    "annualRevenue": 2500000.00,
    "employees": 15,
    "isFirstTime": true
  },
  "scenarios": [
    {
      "name": "Cenário com Certificações",
      "modifications": {
        "certifications": ["ISO_9001", "HACCP"],
        "hasDisabilitySupport": true
      }
    },
    {
      "name": "Cenário Renovação",
      "modifications": {
        "isFirstTime": false,
        "isRenewal": true,
        "previousLicenseDate": "2023-03-15"
      }
    },
    {
      "name": "Cenário Urgente",
      "modifications": {
        "urgentProcessing": true,
        "requestedCompletionDays": 5
      }
    }
  ],
  "processTypes": ["pt-001", "pt-002", "pt-003"]
}
```

**Resposta de Sucesso (200):**
```json
{
  "simulationId": "sim-002",
  "baseScenario": {
    "name": "Cenário Base",
    "totalAmount": 42000.00,
    "breakdown": [
      {
        "processTypeId": "pt-001",
        "processTypeName": "Análise Técnica Inicial",
        "baseAmount": 15000.00,
        "finalAmount": 12000.00,
        "discounts": 3000.00
      },
      {
        "processTypeId": "pt-002",
        "processTypeName": "Inspeção de Segurança",
        "baseAmount": 12000.00,
        "finalAmount": 12000.00,
        "discounts": 0.00
      },
      {
        "processTypeId": "pt-003",
        "processTypeName": "Análise Sanitária",
        "baseAmount": 18000.00,
        "finalAmount": 18000.00,
        "discounts": 0.00
      }
    ]
  },
  "scenarioComparisons": [
    {
      "name": "Cenário com Certificações",
      "totalAmount": 38500.00,
      "savings": 3500.00,
      "savingsPercentage": 8.3,
      "additionalDiscounts": [
        {
          "processTypeId": "pt-001",
          "discountName": "Desconto Certificação Qualidade",
          "amount": 1000.00
        },
        {
          "processTypeId": "pt-003",
          "discountName": "Desconto Inclusão Social",
          "amount": 2500.00
        }
      ]
    },
    {
      "name": "Cenário Renovação",
      "totalAmount": 31500.00,
      "savings": 10500.00,
      "savingsPercentage": 25.0,
      "additionalDiscounts": [
        {
          "processTypeId": "pt-001",
          "discountName": "Desconto Renovação",
          "amount": 4500.00
        },
        {
          "processTypeId": "pt-002",
          "discountName": "Inspeção Simplificada",
          "amount": 6000.00
        }
      ]
    },
    {
      "name": "Cenário Urgente",
      "totalAmount": 63000.00,
      "additionalCost": 21000.00,
      "additionalCostPercentage": 50.0,
      "urgencyFees": [
        {
          "processTypeId": "pt-001",
          "urgencyFee": 7500.00,
          "reason": "Processamento em 5 dias (50% adicional)"
        },
        {
          "processTypeId": "pt-002",
          "urgencyFee": 6000.00,
          "reason": "Inspeção prioritária (50% adicional)"
        },
        {
          "processTypeId": "pt-003",
          "urgencyFee": 7500.00,
          "reason": "Análise acelerada (50% adicional)"
        }
      ]
    }
  ],
  "recommendations": [
    {
      "scenario": "Cenário com Certificações",
      "recommendation": "Obter certificações ISO 9001 e HACCP antes da solicitação pode gerar economia de 8.3%",
      "priority": "HIGH",
      "estimatedEffort": "2-3 meses",
      "investmentRequired": 25000.00
    },
    {
      "scenario": "Cenário Renovação",
      "recommendation": "Para renovações futuras, manter conformidade contínua garante desconto de 25%",
      "priority": "MEDIUM",
      "estimatedEffort": "Contínuo",
      "investmentRequired": 0.00
    }
  ],
  "optimalStrategy": {
    "description": "Obter certificações antes da primeira solicitação e manter conformidade para renovações",
    "totalSavings": 14000.00,
    "timeframe": "Primeira solicitação + renovações futuras",
    "roi": "56% de economia em taxas ao longo de 3 anos"
  }
}
```

---

## 5. Funcionalidades Avançadas

### 5.1 Gestão de Descontos Dinâmicos

#### 5.1.1 Configuração de Descontos Sazonais
**Endpoint:** `POST /api/v1/fee-categories/{feeCategoryId}/seasonal-discounts`

**Payload de Requisição:**
```json
{
  "discountName": "Desconto Fim de Ano",
  "discountType": "PERCENTAGE",
  "discountValue": 15.0,
  "seasonalPeriod": {
    "startMonth": 11,
    "startDay": 1,
    "endMonth": 12,
    "endDay": 31
  },
  "applicableYears": [2025, 2025],
  "conditions": {
    "minimumAmount": 10000.00,
    "applicantTypes": ["INDIVIDUAL", "SMALL_BUSINESS"],
    "maxApplicationsPerApplicant": 1
  },
  "stackable": false,
  "priority": 5
}
```

#### 5.1.2 Análise de Impacto de Descontos
**Endpoint:** `GET /api/v1/fee-categories/{feeCategoryId}/discount-impact`

**Resposta de Sucesso (200):**
```json
{
  "feeCategoryId": "fc-001",
  "analysisPeriod": {
    "startDate": "2025-01-01",
    "endDate": "2025-12-31"
  },
  "discountImpact": {
    "totalApplications": 1250,
    "applicationsWithDiscount": 375,
    "discountRate": 30.0,
    "totalRevenueLoss": 1125000.00,
    "averageDiscountPerApplication": 3000.00
  },
  "discountBreakdown": [
    {
      "discountRule": "Desconto Primeira Licença",
      "applications": 180,
      "totalDiscount": 540000.00,
      "averageDiscount": 3000.00,
      "effectivenessScore": 8.5
    },
    {
      "discountRule": "Desconto Certificação",
      "applications": 95,
      "totalDiscount": 285000.00,
      "averageDiscount": 3000.00,
      "effectivenessScore": 9.2
    },
    {
      "discountRule": "Desconto Inclusão Social",
      "applications": 100,
      "totalDiscount": 300000.00,
      "averageDiscount": 3000.00,
      "effectivenessScore": 7.8
    }
  ],
  "behaviorAnalysis": {
    "applicationIncrease": 25.0,
    "complianceImprovement": 15.0,
    "customerSatisfactionIncrease": 18.0,
    "processingTimeReduction": 8.0
  },
  "recommendations": [
    "Manter desconto para certificações devido ao alto score de efetividade",
    "Revisar critérios do desconto de inclusão social para melhorar efetividade",
    "Considerar desconto adicional para renovações antecipadas"
  ]
}
```

### 5.2 Sistema de Isenções Inteligente

#### 5.2.1 Avaliação Automática de Elegibilidade
**Endpoint:** `POST /api/v1/exemptions/evaluate`

**Payload de Requisição:**
```json
{
  "applicantId": "app-001",
  "applicantProfile": {
    "type": "NGO",
    "registrationNumber": "NGO-2019-001",
    "socialImpactLevel": "HIGH",
    "beneficiaryCount": 500,
    "focusAreas": ["EDUCATION", "DISABILITY_SUPPORT"],
    "annualBudget": 150000.00,
    "governmentFunding": 80.0
  },
  "requestedProcesses": ["pt-001", "pt-002", "pt-003"],
  "supportingDocuments": [
    {
      "documentType": "SOCIAL_IMPACT_REPORT",
      "documentId": "doc-001",
      "verificationStatus": "VERIFIED"
    },
    {
      "documentType": "GOVERNMENT_RECOGNITION",
      "documentId": "doc-002",
      "verificationStatus": "VERIFIED"
    }
  ]
}
```

**Resposta de Sucesso (200):**
```json
{
  "evaluationId": "eval-001",
  "applicantId": "app-001",
  "overallEligibility": "ELIGIBLE",
  "eligibilityScore": 92.5,
  "processEvaluations": [
    {
      "processTypeId": "pt-001",
      "processTypeName": "Análise Técnica Inicial",
      "eligibilityStatus": "ELIGIBLE",
      "exemptionType": "TOTAL",
      "exemptionPercentage": 100.0,
      "exemptionAmount": 15000.00,
      "matchedCriteria": [
        {
          "criteriaName": "Isenção ONGs",
          "matchScore": 100.0,
          "matchReasons": [
            "Tipo de requerente: NGO",
            "Alto impacto social verificado",
            "Reconhecimento governamental válido"
          ]
        }
      ],
      "requiredApprovals": [
        {
          "approvalLevel": "DIRECTOR",
          "approver": "João Silva",
          "status": "PENDING",
          "estimatedTime": "2-3 dias úteis"
        }
      ]
    },
    {
      "processTypeId": "pt-002",
      "processTypeName": "Inspeção de Segurança",
      "eligibilityStatus": "PARTIAL",
      "exemptionType": "PARTIAL",
      "exemptionPercentage": 50.0,
      "exemptionAmount": 6000.00,
      "matchedCriteria": [
        {
          "criteriaName": "Desconto Organizações Sociais",
          "matchScore": 75.0,
          "matchReasons": [
            "Organização sem fins lucrativos",
            "Foco em educação e inclusão"
          ]
        }
      ],
      "requiredApprovals": []
    },
    {
      "processTypeId": "pt-003",
      "processTypeName": "Análise Sanitária",
      "eligibilityStatus": "NOT_ELIGIBLE",
      "exemptionType": "NONE",
      "exemptionPercentage": 0.0,
      "exemptionAmount": 0.00,
      "reasons": [
        "Processo obrigatório sem isenções disponíveis",
        "Critérios de saúde pública não permitem isenção"
      ]
    }
  ],
  "totalExemptionAmount": 21000.00,
  "totalOriginalAmount": 45000.00,
  "totalFinalAmount": 24000.00,
  "savingsPercentage": 46.7,
  "nextSteps": [
    {
      "step": 1,
      "description": "Aguardar aprovação do diretor para isenção total do processo pt-001",
      "estimatedTime": "2-3 dias úteis",
      "responsible": "Sistema de Aprovações"
    },
    {
      "step": 2,
      "description": "Proceder com pagamento reduzido dos processos elegíveis",
      "estimatedTime": "Após aprovação",
      "responsible": "Requerente"
    }
  ],
  "validityPeriod": {
    "evaluationDate": "2025-03-15T14:20:00Z",
    "validUntil": "2025-04-15T14:20:00Z",
    "renewalRequired": false
  }
}
```

---

## 6. Regras de Negócio Específicas

### 6.1 Validações de Integridade Financeira

#### 6.1.1 Regras de Validação de Valores
```java
// Validação de consistência de valores
@AssertTrue(message = "Valor mínimo deve ser menor ou igual ao valor base")
public boolean isMinimumAmountValid() {
    return minimumAmount == null || baseAmount == null || 
           minimumAmount.compareTo(baseAmount) <= 0;
}

@AssertTrue(message = "Valor máximo deve ser maior ou igual ao valor base")
public boolean isMaximumAmountValid() {
    return maximumAmount == null || baseAmount == null || 
           maximumAmount.compareTo(baseAmount) >= 0;
}

// Validação de datas de vigência
@AssertTrue(message = "Data de expiração deve ser posterior à data de vigência")
public boolean isExpirationDateValid() {
    return expirationDate == null || effectiveDate == null || 
           expirationDate.isAfter(effectiveDate);
}
```

#### 6.1.2 Regras de Aplicação de Descontos
```java
// Lógica de aplicação de descontos múltiplos
public BigDecimal calculateFinalAmount(BigDecimal baseAmount, List<DiscountRule> applicableDiscounts) {
    BigDecimal currentAmount = baseAmount;
    
    // Ordenar por prioridade
    List<DiscountRule> sortedDiscounts = applicableDiscounts.stream()
        .sorted(Comparator.comparing(DiscountRule::getPriority))
        .collect(Collectors.toList());
    
    for (DiscountRule discount : sortedDiscounts) {
        if (discount.isStackable() || applicableDiscounts.size() == 1) {
            currentAmount = applyDiscount(currentAmount, discount);
        } else {
            // Para descontos não empilháveis, aplicar apenas o maior
            BigDecimal discountAmount = calculateDiscountAmount(baseAmount, discount);
            if (discountAmount.compareTo(baseAmount.subtract(currentAmount)) > 0) {
                currentAmount = baseAmount.subtract(discountAmount);
            }
        }
    }
    
    return currentAmount.max(minimumAmount != null ? minimumAmount : BigDecimal.ZERO);
}
```

### 6.2 Regras de Elegibilidade

#### 6.2.1 Avaliação de Critérios de Desconto
```java
// Avaliação de condições de desconto
public boolean evaluateDiscountConditions(ApplicantProfile profile, DiscountConditionsDTO conditions) {
    boolean eligible = true;
    
    if (conditions.getApplicantType() != null) {
        eligible &= conditions.getApplicantType().equals(profile.getType());
    }
    
    if (conditions.getMinimumInvestment() != null) {
        eligible &= profile.getInvestment() != null && 
                   profile.getInvestment().compareTo(conditions.getMinimumInvestment()) >= 0;
    }
    
    if (conditions.getMaximumInvestment() != null) {
        eligible &= profile.getInvestment() != null && 
                   profile.getInvestment().compareTo(conditions.getMaximumInvestment()) <= 0;
    }
    
    if (conditions.getIsFirstTime() != null) {
        eligible &= conditions.getIsFirstTime().equals(profile.getIsFirstTime());
    }
    
    if (conditions.getRequiredCertifications() != null && !conditions.getRequiredCertifications().isEmpty()) {
        eligible &= profile.getCertifications() != null && 
                   profile.getCertifications().containsAll(conditions.getRequiredCertifications());
    }
    
    return eligible;
}
```

#### 6.2.2 Avaliação de Critérios de Isenção
```java
// Avaliação de condições de isenção
public boolean evaluateExemptionConditions(ApplicantProfile profile, ExemptionConditionsDTO conditions) {
    boolean eligible = true;
    
    if (conditions.getApplicantCategory() != null) {
        eligible &= conditions.getApplicantCategory().equals(profile.getCategory());
    }
    
    if (conditions.getBusinessSector() != null) {
        eligible &= conditions.getBusinessSector().equals(profile.getBusinessSector());
    }
    
    if (conditions.getSocialImpactLevel() != null) {
        eligible &= profile.getSocialImpactLevel() != null && 
                   profile.getSocialImpactLevel().equals(conditions.getSocialImpactLevel());
    }
    
    if (conditions.getIsPublicInterest() != null) {
        eligible &= conditions.getIsPublicInterest().equals(profile.getIsPublicInterest());
    }
    
    if (conditions.getRequiredDocuments() != null && !conditions.getRequiredDocuments().isEmpty()) {
        eligible &= profile.getSubmittedDocuments() != null && 
                   profile.getSubmittedDocuments().containsAll(conditions.getRequiredDocuments());
    }
    
    return eligible;
}
```

---

## 7. Casos de Uso Específicos

### 7.1 UC001 - Cálculo de Taxa Complexa
**Cenário:** Restaurante com múltiplos descontos e taxa variável

**Dados de Entrada:**
- Tipo: Empresa
- Setor: Restaurante
- Receita Anual: 3.500.000 CVE
- Funcionários: 25
- Primeira licença: Sim
- Certificações: ISO 9001, HACCP
- Localização: Zona Turística

**Cálculo:**
1. Taxa Base: 20.000 CVE
2. Desconto Primeira Licença (20%): -4.000 CVE
3. Desconto Certificação (1.500 CVE): -1.500 CVE
4. Taxa Zona Turística (+15%): +3.000 CVE
5. **Total Final: 17.500 CVE**

### 7.2 UC002 - Isenção para ONG
**Cenário:** ONG de educação solicitando múltiplas licenças

**Critérios de Isenção:**
- Tipo: ONG registrada
- Área: Educação e Inclusão Social
- Impacto: Alto (500+ beneficiários)
- Financiamento: 80% governamental

**Resultado:**
- Análise Técnica: Isenção total (100%)
- Inspeção Segurança: Desconto 50%
- Análise Sanitária: Taxa normal
- **Economia Total: 46.7%**

### 7.3 UC003 - Otimização de Custos
**Cenário:** Empresa planejando expansão com múltiplas licenças

**Estratégia Recomendada:**
1. Obter certificações antes da solicitação
2. Agrupar solicitações para desconto por volume
3. Solicitar durante período promocional
4. **Economia Potencial: 35% (52.500 CVE)**

---

## 8. Integrações e Dependências

### 8.1 Sistemas Externos
- **Sistema de Pagamentos**: Processamento de transações
- **Sistema Bancário**: Validação de transferências
- **Sistema de Contabilidade**: Registro de receitas
- **Sistema de Auditoria**: Rastreamento de alterações

### 8.2 Módulos Internos
- **Tipos de Processo**: Definição de taxas aplicáveis
- **Solicitações**: Cálculo de custos em tempo real
- **Relatórios Financeiros**: Análise de receitas
- **Sistema de Aprovações**: Validação de isenções

---

## 9. Monitoramento e Métricas Financeiras

### 9.1 KPIs de Receita
- Receita total por categoria de taxa
- Taxa de cobrança efetiva
- Tempo médio de pagamento
- Taxa de inadimplência
- Impacto de descontos na receita

### 9.2 Análise de Desempenho
- Efetividade de descontos (aumento de solicitações)
- Utilização de isenções por categoria
- Sazonalidade de receitas
- Comparação com metas orçamentárias

### 9.3 Alertas Automáticos
- Receita abaixo da meta mensal
- Taxa de inadimplência > 5%
- Uso excessivo de isenções
- Descontos não utilizados
- Inconsistências em cálculos

---

## 10. Considerações de Compliance e Auditoria

### 10.1 Rastreabilidade
- Log completo de todas as alterações de taxas
- Histórico de cálculos com justificativas
- Registro de aprovações de isenções
- Auditoria de aplicação de descontos

### 10.2 Conformidade Regulatória
- Validação automática com tabelas oficiais
- Notificação de mudanças regulamentares
- Relatórios para órgãos fiscalizadores
- Backup de configurações históricas

### 10.3 Segurança Financeira
- Controle de acesso a configurações de taxa
- Aprovação obrigatória para alterações críticas
- Validação cruzada de cálculos
- Proteção contra manipulação de valores

Este documento estabelece a base completa para a gestão financeira do sistema de licenciamento, garantindo transparência, eficiência e conformidade regulatória na cobrança de taxas.