# PR02.02-BE-LIC-Gestão de Titulares de Licença

## 1. Visão Geral

Este documento especifica a implementação do módulo de **Gestão de Titulares de Licença** para o Sistema de Licenciamento de Cabo Verde. O módulo é responsável pelo registro, validação e gestão de pessoas físicas e jurídicas que podem ser titulares de licenças, incluindo validação de documentos de identificação, verificação de capacidade legal e gestão de representantes legais.

### 1.1 Objetivos

* Implementar modelo de dados unificado para pessoas físicas e jurídicas
* Implementar arquitetura DDD para gestão de titulares e suas capacidades
* Fornecer APIs REST para registro, consulta e atualização de titulares
* Garantir validações robustas de documentos de identificação
* Suportar gestão de representantes legais e procurações
* Implementar verificações de capacidade legal e conformidade

## 2. Modelo de Dados Normalizado

### 2.1 Diagrama ER

```mermaid
erDiagram
    T_LICENSE_HOLDER {
        uuid id PK
        varchar holder_type
        varchar identification_number
        varchar identification_type
        varchar name
        varchar trade_name
        varchar email
        varchar phone
        varchar address
        varchar parish
        varchar municipality
        varchar island
        varchar postal_code
        varchar nationality
        date birth_date
        varchar gender
        varchar marital_status
        varchar tax_number
        varchar social_security_number
        varchar legal_capacity_status
        varchar status
        boolean active
        jsonb metadata
        timestamp created_at
        timestamp updated_at
        varchar created_by
        varchar updated_by
    }

    T_INDIVIDUAL_HOLDER {
        uuid id PK
        uuid holder_id_fk FK
        varchar full_name
        varchar father_name
        varchar mother_name
        varchar birth_place
        varchar profession
        varchar education_level
        timestamp created_at
        timestamp updated_at
    }

    T_CORPORATE_HOLDER {
        uuid id PK
        uuid holder_id_fk FK
        varchar legal_name
        varchar trade_name
        varchar company_type
        varchar business_sector
        varchar registration_number
        date incorporation_date
        varchar incorporation_country
        decimal share_capital
        timestamp created_at
        timestamp updated_at
    }

    T_LEGAL_REPRESENTATIVE {
        uuid id PK
        uuid corporate_holder_id_fk FK
        varchar representative_name
        varchar identification_type
        varchar identification_number
        varchar representation_type
        text powers_description
        date appointment_date
        date termination_date
        varchar status
        timestamp created_at
        timestamp updated_at
    }

    T_HOLDER_DOCUMENT {
        uuid id PK
        uuid holder_id_fk FK
        varchar document_type
        varchar document_name
        varchar document_url
        varchar mime_type
        bigint file_size
        varchar status
        date issue_date
        date expiry_date
        varchar issuing_authority
        timestamp created_at
        timestamp updated_at
    }

    T_LICENSE_HOLDER ||--o| T_INDIVIDUAL_HOLDER : "extends"
    T_LICENSE_HOLDER ||--o| T_CORPORATE_HOLDER : "extends"
    T_CORPORATE_HOLDER ||--o{ T_LEGAL_REPRESENTATIVE : "has representatives"
    T_LICENSE_HOLDER ||--o{ T_HOLDER_DOCUMENT : "has documents"
```

## 3. Arquitetura DDD

### 3.1 Domain Layer

#### 3.1.1 Aggregate Root: LicenseHolder

```java
@Entity
@Table(name = "t_license_holder")
@Inheritance(strategy = InheritanceType.JOINED)
@DiscriminatorColumn(name = "holder_type")
public abstract class LicenseHolder extends AggregateRoot<LicenseHolderId> {
    
    @EmbeddedId
    private LicenseHolderId id;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "holder_type", insertable = false, updatable = false)
    private HolderType holderType;
    
    @Embedded
    private Identification identification;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Embedded
    private ContactInfo contactInfo;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "legal_capacity_status")
    private LegalCapacityStatus legalCapacityStatus;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status")
    private HolderStatus status;
    
    @OneToMany(mappedBy = "holder", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<HolderDocument> documents = new ArrayList<>();
    
    // Métodos de negócio abstratos
    public abstract boolean isEligibleForLicense(LicenseType licenseType);
    public abstract void validateForLicenseApplication(LicenseType licenseType);
    
    // Métodos de negócio comuns
    public void updateContactInfo(ContactInfo newContactInfo, String updatedBy) {
        this.contactInfo = newContactInfo;
        this.updatedBy = updatedBy;
        this.updatedAt = Instant.now();
        
        addDomainEvent(new HolderContactUpdatedEvent(this.id));
    }
    
    public void addDocument(String documentType, String documentName, 
                           String documentUrl, String mimeType, Long fileSize,
                           LocalDate issueDate, LocalDate expiryDate, 
                           String issuingAuthority, String uploadedBy) {
        
        HolderDocument document = HolderDocument.create(
            this, documentType, documentName, documentUrl, mimeType, 
            fileSize, issueDate, expiryDate, issuingAuthority, uploadedBy
        );
        
        this.documents.add(document);
        
        addDomainEvent(new HolderDocumentAddedEvent(this.id, document.getId()));
    }
    
    public void activate(String updatedBy) {
        if (this.status == HolderStatus.ACTIVE) {
            throw new DomainException("Holder is already active");
        }
        
        validateLegalCapacity();
        
        this.status = HolderStatus.ACTIVE;
        this.updatedBy = updatedBy;
        this.updatedAt = Instant.now();
        
        addDomainEvent(new HolderActivatedEvent(this.id));
    }
    
    protected abstract void validateLegalCapacity();
}
```

Este documento foi corrigido para resolver os problemas de formatação identificados.